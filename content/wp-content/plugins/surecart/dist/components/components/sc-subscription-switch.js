import{proxyCustomElement,HTMLElement,h,Fragment}from"@stencil/core/internal/client";import{a as apiFetch}from"./fetch.js";import{o as onFirstVisible}from"./lazy.js";import{i as intervalString}from"./price.js";import{d as defineCustomElement$g}from"./sc-alert2.js";import{d as defineCustomElement$f}from"./sc-block-ui2.js";import{d as defineCustomElement$e}from"./sc-button2.js";import{d as defineCustomElement$d}from"./sc-choice2.js";import{d as defineCustomElement$c}from"./sc-choices2.js";import{d as defineCustomElement$b}from"./sc-dashboard-module2.js";import{d as defineCustomElement$a}from"./sc-flex2.js";import{d as defineCustomElement$9}from"./sc-form2.js";import{d as defineCustomElement$8}from"./sc-form-control2.js";import{d as defineCustomElement$7}from"./sc-format-number2.js";import{d as defineCustomElement$6}from"./sc-icon2.js";import{d as defineCustomElement$5}from"./sc-skeleton2.js";import{d as defineCustomElement$4}from"./sc-spinner2.js";import{d as defineCustomElement$3}from"./sc-tag2.js";import{d as defineCustomElement$2}from"./sc-tooltip2.js";import{a as addQueryArgs}from"./add-query-args.js";const scSubscriptionSwitchCss=":host{display:block;position:relative}[hidden]{display:none !important}.subscriptions-switch{display:grid;gap:0.5em}.subscriptions-switch__switcher{background:rgba(0, 0, 0, 0.035);padding:2px;line-height:1;border-radius:var(--sc-border-radius-small)}",ScSubscriptionSwitch$1=proxyCustomElement(class extends HTMLElement{constructor(){super(),this.__registerHost(),this.__attachShadow(),this.filterAbove=4,this.products=[],this.filter="month"}componentWillLoad(){onFirstVisible(this.el,(async()=>{try{this.loading=!0,await Promise.all([this.getGroup(),this.getProductPrices()])}catch(e){console.error(e),(null==e?void 0:e.message)?this.error=e.message:this.error=wp.i18n.__("Something went wrong","surecart")}finally{this.loading=!1}})),this.handleSubscriptionChange()}handleProductsChange(){var e;this.prices=this.products.map((e=>{var t,i;return null===(i=null===(t=e)||void 0===t?void 0:t.prices)||void 0===i?void 0:i.data})).flat().filter(((e,t,i)=>i.findIndex((t=>t.id===e.id))===t)).filter((e=>!(null==e?void 0:e.archived))),this.showFilters=(null===(e=this.prices)||void 0===e?void 0:e.length)>this.filterAbove}handlePricesChange(e,t){!(null==t?void 0:t.length)&&(null==e?void 0:e.length)&&(this.selectedPrice=e.find((e=>{var t,i;return e.id===(null===(i=null===(t=this.subscription)||void 0===t?void 0:t.price)||void 0===i?void 0:i.id)}))),this.hasFilters={...this.hasFilters,split:this.prices.some((e=>"month"===e.recurring_interval&&(null==e?void 0:e.recurring_period_count)&&!(null==e?void 0:e.archived))),month:this.prices.some((e=>"month"===e.recurring_interval&&!(null==e?void 0:e.recurring_period_count)&&!(null==e?void 0:e.archived))),year:this.prices.some((e=>"year"===e.recurring_interval&&!(null==e?void 0:e.archived))),never:this.prices.some((e=>!("never"!==e.recurring_interval&&e.recurring_interval||(null==e?void 0:e.archived))))}}handleSubscriptionChange(){var e,t;this.filter=(null===(t=null===(e=this.subscription)||void 0===e?void 0:e.price)||void 0===t?void 0:t.recurring_interval)||"month"}async getGroup(){if(!this.productGroupId)return;const e=await await apiFetch({path:addQueryArgs("surecart/v1/products/",{product_group_ids:[this.productGroupId],expand:["prices"],...this.query})});this.products=[...this.products,...e]}async getProductPrices(){if(!this.productId)return;const e=await await apiFetch({path:addQueryArgs(`surecart/v1/products/${this.productId}`,{expand:["prices"]})});this.products=[...this.products,e]}async handleSubmit(e){var t;const{plan:i}=await e.target.getFormJson(),s=this.prices.find((e=>e.id===i)),r=null===(t=this.subscription)||void 0===t?void 0:t.price;if((null==s?void 0:s.id)!==r.id||(null==s?void 0:s.ad_hoc)){if(null==s?void 0:s.ad_hoc)return this.busy=!0,window.location.assign(addQueryArgs(window.location.href,{action:"confirm_amount",price_id:i}));this.busy=!0,window.location.assign(addQueryArgs(window.location.href,{action:"confirm",price_id:i}))}}renderSwitcher(){if(Object.values(this.hasFilters||{}).filter((e=>!!e)).length>1&&this.showFilters)return h("sc-flex",{slot:"end",class:"subscriptions-switch__switcher"},this.hasFilters.month&&h("sc-button",{onClick:()=>this.filter="month",size:"small",type:"month"===this.filter?"default":"text"},wp.i18n.__("Monthly","surecart")),this.hasFilters.week&&h("sc-button",{onClick:()=>this.filter="week",size:"small",type:"week"===this.filter?"default":"text"},wp.i18n.__("Weekly","surecart")),this.hasFilters.year&&h("sc-button",{onClick:()=>this.filter="year",size:"small",type:"year"===this.filter?"default":"text"},wp.i18n.__("Yearly","surecart")),this.hasFilters.never&&h("sc-button",{onClick:()=>this.filter="never",size:"small",type:"never"===this.filter?"default":"text"},wp.i18n.__("Lifetime","surecart")),this.hasFilters.split&&h("sc-button",{onClick:()=>this.filter="split",size:"small",type:"split"===this.filter?"default":"text"},wp.i18n.__("Payment Plan","surecart")))}renderLoading(){return h("sc-choice",{name:"loading",disabled:!0},h("sc-skeleton",{style:{width:"60px",display:"inline-block"}}),h("sc-skeleton",{style:{width:"80px",display:"inline-block"},slot:"price"}),h("sc-skeleton",{style:{width:"120px",display:"inline-block"},slot:"description"}))}isHidden(e){if(!this.showFilters)return!1;let t=this.filter!==e.recurring_interval;return"never"!==this.filter||(null==e?void 0:e.recurring_interval)||(t=!1),"split"===this.filter&&(null==e?void 0:e.recurring_period_count)&&(t=!1),t}renderContent(){return this.loading?this.renderLoading():h("sc-choices",{required:!0},h("div",null,(this.prices||[]).filter((e=>!e.archived)).filter((e=>{var t;return(null==e?void 0:e.currency)===(null===(t=this.subscription)||void 0===t?void 0:t.currency)})).map((e=>{var t,i;const s=(null===(i=null===(t=this.subscription)||void 0===t?void 0:t.price)||void 0===i?void 0:i.id)===(null==e?void 0:e.id),r=this.products.find((t=>t.id===(null==e?void 0:e.product)));return h("sc-choice",{key:null==e?void 0:e.id,checked:s,name:"plan",value:null==e?void 0:e.id,hidden:this.isHidden(e),onScChange:t=>{t.detail&&(this.selectedPrice=this.prices.find((t=>t.id===(null==e?void 0:e.id))))}},h("div",null,h("strong",null,(null==e?void 0:e.name)||(null==r?void 0:r.name))),h("div",{slot:"description"},(null==e?void 0:e.ad_hoc)?`${wp.i18n.__("Custom amount","surecart")} ${intervalString(e)}`:h(Fragment,null,h("sc-format-number",{type:"currency",currency:(null==e?void 0:e.currency)||"usd",value:null==e?void 0:e.amount})," ",intervalString(e,{showOnce:!0}))),s&&h("sc-tag",{type:"warning",slot:"price"},wp.i18n.__("Current Plan","surecart")))}))))}buttonText(){var e,t,i,s;return(null===(e=this.selectedPrice)||void 0===e?void 0:e.ad_hoc)?(null===(t=this.selectedPrice)||void 0===t?void 0:t.id)===(null===(s=null===(i=this.subscription)||void 0===i?void 0:i.price)||void 0===s?void 0:s.id)?wp.i18n.__("Update Amount","surecart"):wp.i18n.__("Choose Amount","surecart"):wp.i18n.__("Next","surecart")}render(){var e,t,i,s,r,n,o,c;return!this.loading&&(null===(e=this.prices)||void 0===e?void 0:e.length)<2&&!(null===(i=null===(t=this.prices)||void 0===t?void 0:t[0])||void 0===i?void 0:i.ad_hoc)?null:(null===(s=this.subscription)||void 0===s?void 0:s.finite)?h("sc-alert",{type:"info",open:!0},wp.i18n.__("To make changes to your payment plan, please contact us.","surecart")):h("sc-dashboard-module",{heading:this.heading||wp.i18n.__("Update Plan","surecart"),class:"subscription-switch",error:this.error},h("span",{slot:"end"},this.renderSwitcher()),h("sc-form",{class:"subscriptions-switch",onScFormSubmit:e=>this.handleSubmit(e)},this.renderContent(),h("sc-button",{type:"primary",full:!0,submit:!0,loading:this.loading||this.busy,disabled:(null===(n=null===(r=this.subscription)||void 0===r?void 0:r.price)||void 0===n?void 0:n.id)===(null===(o=this.selectedPrice)||void 0===o?void 0:o.id)&&!(null===(c=this.selectedPrice)||void 0===c?void 0:c.ad_hoc)},this.buttonText()," ",h("sc-icon",{name:"arrow-right",slot:"suffix"})),this.busy&&h("sc-block-ui",{style:{zIndex:"9"}})))}get el(){return this}static get watchers(){return{products:["handleProductsChange"],prices:["handlePricesChange"],subscription:["handleSubscriptionChange"]}}static get style(){return scSubscriptionSwitchCss}},[1,"sc-subscription-switch",{query:[16],heading:[1],productGroupId:[16],productId:[1,"product-id"],subscription:[16],filterAbove:[2,"filter-above"],selectedPrice:[32],products:[32],prices:[32],filter:[32],hasFilters:[32],showFilters:[32],loading:[32],busy:[32],error:[32]}]);function defineCustomElement$1(){"undefined"!=typeof customElements&&["sc-subscription-switch","sc-alert","sc-block-ui","sc-button","sc-choice","sc-choices","sc-dashboard-module","sc-flex","sc-form","sc-form-control","sc-format-number","sc-icon","sc-skeleton","sc-spinner","sc-tag","sc-tooltip"].forEach((e=>{switch(e){case"sc-subscription-switch":customElements.get(e)||customElements.define(e,ScSubscriptionSwitch$1);break;case"sc-alert":customElements.get(e)||defineCustomElement$g();break;case"sc-block-ui":customElements.get(e)||defineCustomElement$f();break;case"sc-button":customElements.get(e)||defineCustomElement$e();break;case"sc-choice":customElements.get(e)||defineCustomElement$d();break;case"sc-choices":customElements.get(e)||defineCustomElement$c();break;case"sc-dashboard-module":customElements.get(e)||defineCustomElement$b();break;case"sc-flex":customElements.get(e)||defineCustomElement$a();break;case"sc-form":customElements.get(e)||defineCustomElement$9();break;case"sc-form-control":customElements.get(e)||defineCustomElement$8();break;case"sc-format-number":customElements.get(e)||defineCustomElement$7();break;case"sc-icon":customElements.get(e)||defineCustomElement$6();break;case"sc-skeleton":customElements.get(e)||defineCustomElement$5();break;case"sc-spinner":customElements.get(e)||defineCustomElement$4();break;case"sc-tag":customElements.get(e)||defineCustomElement$3();break;case"sc-tooltip":customElements.get(e)||defineCustomElement$2()}}))}defineCustomElement$1();const ScSubscriptionSwitch=ScSubscriptionSwitch$1,defineCustomElement=defineCustomElement$1;export{ScSubscriptionSwitch,defineCustomElement};