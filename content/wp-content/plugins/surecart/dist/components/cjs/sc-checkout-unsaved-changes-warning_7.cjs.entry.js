"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const index=require("./index-9c866aeb.js"),store=require("./store-6708f186.js"),fetch=require("./fetch-b673a242.js"),index$1=require("./index-2840f0ff.js"),watchers=require("./watchers-203d7acd.js"),mutations=require("./mutations-5cf514b3.js"),addQueryArgs=require("./add-query-args-17c551b6.js"),watchers$1=require("./watchers-d5742848.js"),formData=require("./form-data-9342e967.js"),getQueryArg=require("./get-query-arg-53bf21e2.js");require("./index-f6f80680.js"),require("./watchers-be62d6ad.js"),require("./getters-c6087113.js"),require("./util-98cb3494.js");const ScCheckoutUnsavedChangesWarning=class{constructor(e){index.registerInstance(this,e)}componentDidLoad(){window.addEventListener("beforeunload",(e=>this.warnIfUnsavedChanges(e)),{capture:!0})}warnIfUnsavedChanges(e){if(["updating","finalizing","confirming"].includes(this.state))return console.log({e:e}),e.preventDefault(),e.returnValue=wp.i18n.__("Your payment is processing. Exiting this page could cause an error in your order. Please do not navigate away from this page.","surecart"),e.returnValue}},ScFormComponentsValidator=class{constructor(e){index.registerInstance(this,e)}handleOrderChange(){var e,t,r,i,s,a;this.disabled||(("address_invalid"===(null===(e=null==this?void 0:this.order)||void 0===e?void 0:e.tax_status)||(null===(t=null==this?void 0:this.order)||void 0===t?void 0:t.shipping_enabled))&&this.addAddressField(),(null===(s=null===(i=null===(r=null==this?void 0:this.order)||void 0===r?void 0:r.recommended_bumps)||void 0===i?void 0:i.data)||void 0===s?void 0:s.length)&&this.addBumps(),(null===(a=this.order)||void 0===a?void 0:a.tax_amount)&&this.addTaxLine())}componentWillLoad(){var e,t;this.hasAddress=!!this.el.querySelector("sc-order-shipping-address"),this.hasTaxIDField=!!this.el.querySelector("sc-order-tax-id-input"),this.hasBumpsField=!!this.el.querySelector("sc-order-bumps"),this.hasTaxLine=!!this.el.querySelector("sc-line-item-tax"),(null===(e=this.taxProtocol)||void 0===e?void 0:e.tax_enabled)&&(this.addAddressField(),(null===(t=this.taxProtocol)||void 0===t?void 0:t.eu_vat_required)&&this.addTaxIDField()),this.handleOrderChange()}addAddressField(){if(this.hasAddress)return;const e=this.el.querySelector("sc-payment"),t=document.createElement("sc-order-shipping-address");t.label=wp.i18n.__("Address","surecart"),e.parentNode.insertBefore(t,e),this.hasAddress=!0}addTaxIDField(){if(this.hasTaxIDField)return;const e=this.el.querySelector("sc-payment"),t=document.createElement("sc-order-tax-id-input");e.parentNode.insertBefore(t,e),this.hasTaxIDField=!0}addBumps(){if(this.hasBumpsField)return;const e=this.el.querySelector("sc-payment"),t=document.createElement("sc-order-bumps");e.parentNode.insertBefore(t,e.nextSibling),this.hasBumpsField=!0}addTaxLine(){var e;if(this.hasTaxLine)return;const t=this.el.querySelector("sc-line-item-total[total=total]"),r=document.createElement("sc-line-item-tax");"SC-DIVIDER"===(null===(e=null==t?void 0:t.previousElementSibling)||void 0===e?void 0:e.tagName)?t.parentNode.insertBefore(r,t.previousElementSibling):t.parentNode.insertBefore(r,t),this.hasTaxLine=!0}render(){return index.h("slot",null)}get el(){return index.getElement(this)}static get watchers(){return{order:["handleOrderChange"]}}},ScFormErrorProvider=class{constructor(e){index.registerInstance(this,e),this.scUpdateError=index.createEvent(this,"scUpdateError",7),this.scSetState=index.createEvent(this,"scSetState",7)}handleErrorUpdate(e){this.scUpdateError.emit(e)}handleStateChange(e){["finalizing","updating"].includes(e)&&(this.error=null)}handleErrorEvent(e){this.error=e.detail,Object.keys((null==e?void 0:e.detail)||{}).length&&this.scSetState.emit("REJECT")}handlePayError(e){var t;this.error=(null===(t=e.detail)||void 0===t?void 0:t.message)||{code:"",message:"Something went wrong with your payment."}}componentWillLoad(){this.maybeAddErrorsComponent()}maybeAddErrorsComponent(){if(this.el.querySelector("sc-checkout-form-errors"))return;const e=document.createElement("sc-checkout-form-errors");console.log(this.el.querySelector("sc-form")),this.el.querySelector("sc-form").prepend(e)}render(){return index.h("slot",null)}get el(){return index.getElement(this)}static get watchers(){return{error:["handleErrorUpdate"],checkoutState:["handleStateChange"]}}},service=store.v(store.checkoutMachine);service.subscribe((e=>store.state.formState=e)),service.start();const{send:send}=service,updateFormState=e=>send(e),ScFormStateProvider=class{constructor(e){index.registerInstance(this,e),this.scSetCheckoutFormState=index.createEvent(this,"scSetCheckoutFormState",7),this._stateService=store.v(store.checkoutMachine),this.checkoutState=store.checkoutMachine.initialState}setState(e){const{send:t}=this._stateService;return updateFormState(e),t(e)}handleCheckoutStateChange(e){this.scSetCheckoutFormState.emit(e.value)}componentWillLoad(){this._stateService.subscribe((e=>this.checkoutState=e)),this._stateService.start()}disconnectedCallback(){this._stateService.stop()}handleSetStateEvent(e){this.setState(e.detail)}async handlePaid(){this.setState("PAID")}render(){return"expired"===this.checkoutState.value?index.h("sc-block-ui",null,index.h("div",null,wp.i18n.__("Please refresh the page.","surecart"))):index.h("slot",null)}static get watchers(){return{checkoutState:["handleCheckoutStateChange"]}}},scLoginProviderCss=":host{display:block}",ScLoginProvider=class{constructor(e){index.registerInstance(this,e),this.scSetLoggedIn=index.createEvent(this,"scSetLoggedIn",7),this.scSetCustomer=index.createEvent(this,"scSetCustomer",7)}handleLoginPrompt(){this.open=!0}handleLoginDialogChange(e){e&&setTimeout((()=>{this.loginForm.querySelector("sc-input").triggerFocus()}),100)}handleLoggedInChange(e,t){!1===t&&e&&(this.notice=!0)}handleOrderChange(e,t){(null==e?void 0:e.updated_at)!==(null==t?void 0:t.updated_at)&&(this.notice=!1)}async handleFormSubmit(e){e.preventDefault(),e.stopImmediatePropagation(),this.error=null;const{login:t,password:r}=await e.target.getFormJson();try{this.loading=!0;const{name:e,email:i}=await fetch.apiFetch({method:"POST",path:"surecart/v1/login",data:{login:t,password:r}});this.scSetLoggedIn.emit(!0),this.scSetCustomer.emit({name:e,email:i}),this.open=!1}catch(e){console.error(e),this.error=(null==e?void 0:e.message)||wp.i18n.__("Something went wrong","surecart")}finally{this.loading=!1}}render(){return index.h(index.Host,null,!!this.notice&&index.h("sc-alert",{type:"success",open:!0,style:{marginBottom:"var(--sc-form-row-spacing)"},closable:!0},index.h("span",{slot:"title"},wp.i18n.__("Welcome back!","surecart")),wp.i18n.__("You have logged in successfully.","surecart")),index.h("slot",null),!this.loggedIn&&index.h("sc-dialog",{label:wp.i18n.__("Login to your account","surecart"),open:this.open,onScRequestClose:()=>this.open=!1},index.h("sc-form",{ref:e=>this.loginForm=e,onScFormSubmit:e=>{e.preventDefault(),e.stopImmediatePropagation()},onScSubmit:e=>this.handleFormSubmit(e)},!!this.error&&index.h("sc-alert",{type:"danger",open:!!this.error},this.error),index.h("sc-input",{label:wp.i18n.__("Email or Username","surecart"),type:"text",name:"login",required:!0,autofocus:this.open}),index.h("sc-input",{label:wp.i18n.__("Password","surecart"),type:"password",name:"password",required:!0}),index.h("sc-button",{type:"primary",full:!0,loading:this.loading,submit:!0},wp.i18n.__("Login","surecart")))))}static get watchers(){return{open:["handleLoginDialogChange"],loggedIn:["handleLoggedInChange"],order:["handleOrderChange"]}}};ScLoginProvider.style=scLoginProviderCss;const scOrderConfirmProviderCss=".confirm__icon{margin-bottom:var(--sc-spacing-medium);display:flex;justify-content:center}.confirm__icon-container{background:var(--sc-color-primary-500);width:55px;height:55px;border-radius:999999px;display:flex;align-items:center;justify-content:center;font-size:26px;line-height:1;color:white}sc-dialog::part(overlay){backdrop-filter:blur(4px)}",ScOrderConfirmProvider=class{constructor(e){index.registerInstance(this,e),this.scOrderPaid=index.createEvent(this,"scOrderPaid",7),this.scSetState=index.createEvent(this,"scSetState",7),this.scError=index.createEvent(this,"scError",7),this.showSuccessModal=!1}handlePaidEvent(){this.confirmOrder()}async confirmOrder(){var e,t,r;try{this.confirmedCheckout=await fetch.apiFetch({method:"PATCH",path:addQueryArgs.addQueryArgs(`surecart/v1/checkouts/${null===(e=null===watchers.state||void 0===watchers.state?void 0:watchers.state.checkout)||void 0===e?void 0:e.id}/confirm`,[index$1.expand])}),this.scSetState.emit("CONFIRMED"),this.scOrderPaid.emit(this.confirmedCheckout)}catch(e){console.error(e),this.scError.emit(e)}finally{mutations.clearCheckout();const e=(null===(r=null===(t=this.confirmedCheckout)||void 0===t?void 0:t.metadata)||void 0===r?void 0:r.success_url)||this.successUrl;e?(this.scSetState.emit("REDIRECT"),setTimeout((()=>{var t;return window.location.assign(addQueryArgs.addQueryArgs(e,{order:null===(t=this.confirmedCheckout)||void 0===t?void 0:t.id}))}),50)):this.showSuccessModal=!0}}getSuccessUrl(){var e,t,r,i,s;const a=(null===(t=null===(e=this.confirmedCheckout)||void 0===e?void 0:e.metadata)||void 0===t?void 0:t.success_url)||this.successUrl;return a?addQueryArgs.addQueryArgs(a,{order:null===(r=this.confirmedCheckout)||void 0===r?void 0:r.id}):null===(s=null===(i=null===window||void 0===window?void 0:window.scData)||void 0===i?void 0:i.pages)||void 0===s?void 0:s.dashboard}render(){var e,t,r,i;const s=null===(e=this.confirmedCheckout)||void 0===e?void 0:e.manual_payment_method;return index.h(index.Host,null,index.h("slot",null),index.h("sc-dialog",{open:!!this.showSuccessModal,style:{"--body-spacing":"var(--sc-spacing-xxx-large)"},noHeader:!0,onScRequestClose:e=>e.preventDefault()},index.h("div",{class:"confirm__icon"},index.h("div",{class:"confirm__icon-container"},index.h("sc-icon",{name:"check"}))),index.h("sc-dashboard-module",{heading:(null===(t=this.successText)||void 0===t?void 0:t.title)||wp.i18n.__("Thanks for your order!","surecart"),style:{"--sc-dashboard-module-spacing":"var(--sc-spacing-x-large)",textAlign:"center"}},index.h("span",{slot:"description"},(null===(r=this.successText)||void 0===r?void 0:r.description)||wp.i18n.__("Your payment was successful, and your order is complete. A receipt is on its way to your inbox.","surecart")),!!(null==s?void 0:s.name)&&!!(null==s?void 0:s.instructions)&&index.h("sc-alert",{type:"info",open:!0,style:{"text-align":"left"}},index.h("span",{slot:"title"},null==s?void 0:s.name),null==s?void 0:s.instructions.split("\n").map((e=>index.h("p",null,e)))),index.h("sc-button",{href:this.getSuccessUrl(),size:"large",type:"primary"},(null===(i=this.successText)||void 0===i?void 0:i.button)||wp.i18n.__("Continue","surecart"),index.h("sc-icon",{name:"arrow-right",slot:"suffix"})))))}get el(){return index.getElement(this)}};ScOrderConfirmProvider.style=scOrderConfirmProviderCss;const ScSessionProvider=class{constructor(e){index.registerInstance(this,e),this.scUpdateOrderState=index.createEvent(this,"scUpdateOrderState",7),this.scUpdateDraftState=index.createEvent(this,"scUpdateDraftState",7),this.scPaid=index.createEvent(this,"scPaid",7),this.scError=index.createEvent(this,"scError",7),this.scSetState=index.createEvent(this,"scSetState",7),this.prices=[],this.persist=!0}handlePricesChange(){let e=this.addInitialPrices()||[];if(e=this.addPriceChoices(e),null==e?void 0:e.length)return this.loadUpdate({line_items:e})}async finalize(){return await this.handleFormSubmit()}async getFormData(){let e={};const t=this.el.querySelector("sc-form");if(t){const r=await t.getFormJson();e=formData.parseFormData(r)}return e}async handleFormSubmit(){var e,t,r,i,s,a,o,n,d;this.scError.emit({}),updateFormState("FINALIZE");let c=await this.getFormData();if((null===(e=null===window||void 0===window?void 0:window.scData)||void 0===e?void 0:e.recaptcha_site_key)&&(null===window||void 0===window?void 0:window.grecaptcha))try{c.grecaptcha=await window.grecaptcha.execute(window.scData.recaptcha_site_key,{action:"surecart_checkout_submit"})}catch(e){return console.error(e),updateFormState("REJECT"),void this.handleErrorResponse(e)}try{await this.update(c)}catch(e){console.error(e),updateFormState("REJECT"),this.handleErrorResponse(e)}try{return watchers.state.checkout=await index$1.finalizeCheckout({id:null===(t=null===watchers.state||void 0===watchers.state?void 0:watchers.state.checkout)||void 0===t?void 0:t.id,query:{...(null===watchers$1.state||void 0===watchers$1.state?void 0:watchers$1.state.method)?{payment_method_type:null===watchers$1.state||void 0===watchers$1.state?void 0:watchers$1.state.method}:{},return_url:addQueryArgs.addQueryArgs(window.location.href,{...(null===(r=null===watchers.state||void 0===watchers.state?void 0:watchers.state.checkout)||void 0===r?void 0:r.id)?{checkout_id:null===(i=null===watchers.state||void 0===watchers.state?void 0:watchers.state.checkout)||void 0===i?void 0:i.id}:{},is_surecart_payment_redirect:!0})},data:c,processor:{id:watchers$1.state.id,manual:watchers$1.state.manual}}),["paid","processing"].includes(null===(s=watchers.state.checkout)||void 0===s?void 0:s.status)&&this.scPaid.emit(),(null===(d=null===(n=null===(o=null===(a=watchers.state.checkout)||void 0===a?void 0:a.payment_intent)||void 0===o?void 0:o.processor_data)||void 0===n?void 0:n.mollie)||void 0===d?void 0:d.checkout_url)?(updateFormState("PAYING"),setTimeout((()=>{var e,t,r,i;return window.location.assign(null===(i=null===(r=null===(t=null===(e=watchers.state.checkout)||void 0===e?void 0:e.payment_intent)||void 0===t?void 0:t.processor_data)||void 0===r?void 0:r.mollie)||void 0===i?void 0:i.checkout_url)}),50)):(setTimeout((()=>{updateFormState("PAYING")}),50),watchers.state.checkout)}catch(e){console.error(e),this.handleErrorResponse(e)}}async handlePaid(){updateFormState("PAID")}async handlePayError(){updateFormState("REJECT")}async handleAbandonedCartUpdate(e){const t=e.detail;this.loadUpdate({abandoned_checkout_enabled:t})}async handleCouponApply(e){const t=e.detail;this.scError.emit({}),this.loadUpdate({discount:{...t?{promotion_code:t}:{}}})}componentDidLoad(){this.findOrCreateOrder()}async findOrCreateOrder(){var e;const{redirect_status:t,checkout_id:r,line_items:i,coupon:s,is_surecart_payment_redirect:a}=addQueryArgs.getQueryArgs(window.location.href);if(window.history.replaceState({},document.title,watchers.removeQueryArgs(window.location.href,"redirect_status","coupon","line_items","confirm_checkout_id","checkout_id")),a&&r)return updateFormState("FINALIZE"),updateFormState("PAYING"),this.handleCheckoutIdFromUrl(r,s);if(t)return this.handleRedirectStatus(t,r);if(r)return this.handleCheckoutIdFromUrl(r,s);if(i)return this.handleInitialLineItems(i,s);const o=null===(e=null===watchers.state||void 0===watchers.state?void 0:watchers.state.checkout)||void 0===e?void 0:e.id;return o&&this.persist?this.handleExistingCheckout(o,s):this.handleNewCheckout(s)}async handleRedirectStatus(e,t){var r,i;if(console.info("Handling payment redirect."),"failed"===e)return this.scError.emit({message:wp.i18n.__("Payment unsuccessful. Please try again.","surecart")});if(!t)return this.scError.emit({message:wp.i18n.__("Could not find checkout. Please contact us before attempting to purchase again.","surecart")});try{updateFormState("FINALIZE"),updateFormState("PAID"),watchers.state.checkout=await index$1.fetchCheckout({id:t,query:{refresh_status:!0}}),(null===(r=watchers.state.checkout)||void 0===r?void 0:r.status)&&["paid","processing"].includes(null===(i=watchers.state.checkout)||void 0===i?void 0:i.status)&&setTimeout((()=>{this.scPaid.emit()}),100)}catch(e){this.handleErrorResponse(e)}}async handleCheckoutIdFromUrl(e,t=""){var r;if(console.info("Handling existing checkout from url.",t,e),t)return this.loadUpdate({id:e,discount:{promotion_code:t}});try{updateFormState("FETCH"),watchers.state.checkout=await index$1.fetchCheckout({id:e,query:{refresh_status:!0}}),updateFormState("RESOLVE")}catch(e){this.handleErrorResponse(e)}switch(null===(r=watchers.state.checkout)||void 0===r?void 0:r.status){case"paid":case"processing":return setTimeout((()=>{updateFormState("FINALIZE"),updateFormState("PAID"),this.scPaid.emit()}),100);case"payment_failed":return mutations.clearCheckout(),this.scError.emit({message:wp.i18n.__("Payment unsuccessful. Please try again.","surecart")});case"payment_intent_canceled":case"canceled":return mutations.clearCheckout(),this.scError.emit({message:wp.i18n.__("Payment canceled. Please try again.","surecart")});case"finalized":this.scError.emit({message:wp.i18n.__("Payment unsuccessful. Please try again.","surecart")}),updateFormState("REJECT")}}async handleInitialLineItems(e,t){console.info("Handling initial line items.");const r=this.el.querySelector("sc-order-shipping-address");return mutations.clearCheckout(),this.loadUpdate({line_items:e,...t?{discount:{promotion_code:t}}:{},...(null==r?void 0:r.defaultCountry)?{shipping_address:{country:null==r?void 0:r.defaultCountry}}:{}})}async handleNewCheckout(e){console.info("Handling new checkout.");const t=this.getFormData(),r=this.addPriceChoices(this.addInitialPrices()||[]),i=this.el.querySelector("sc-order-shipping-address");try{updateFormState("FETCH"),watchers.state.checkout=await index$1.createOrUpdateCheckout({data:{...t,...e?{discount:{promotion_code:e}}:{},...(null==i?void 0:i.defaultCountry)?{shipping_address:{country:null==i?void 0:i.defaultCountry}}:{},line_items:r}}),updateFormState("RESOLVE")}catch(e){console.error(e),this.handleErrorResponse(e)}}async handleExistingCheckout(e,t){if(!e)return this.handleNewCheckout(t);console.info("Handling existing checkout.");try{updateFormState("FETCH"),watchers.state.checkout=await index$1.createOrUpdateCheckout({id:e,data:{...t?{discount:{promotion_code:t}}:{}}}),updateFormState("RESOLVE")}catch(e){console.error(e),this.handleErrorResponse(e)}}async handleErrorResponse(e){var t,r,i,s;if(["checkout.not_found"].includes(null==e?void 0:e.code))return window.history.replaceState({},document.title,watchers.removeQueryArgs(window.location.href,"checkout_id")),mutations.clearCheckout(),this.handleNewCheckout(!1);if("order.line_items.old_price_versions"!==(null===(r=null===(t=null==e?void 0:e.additional_errors)||void 0===t?void 0:t[0])||void 0===r?void 0:r.code)){if(["order.invalid_status_transition"].includes(null==e?void 0:e.code))return await this.loadUpdate({id:null===(s=null===watchers.state||void 0===watchers.state?void 0:watchers.state.checkout)||void 0===s?void 0:s.id,data:{status:"draft"}}),void this.handleFormSubmit();if("rest_cookie_invalid_nonce"!==(null==e?void 0:e.code)){if("readonly"===(null==e?void 0:e.code))return mutations.clearCheckout(),void window.location.assign(watchers.removeQueryArgs(window.location.href,"order"));console.log("emit",e),this.scError.emit(e),updateFormState("REJECT")}else updateFormState("EXPIRE")}else await this.loadUpdate({id:null===(i=null===watchers.state||void 0===watchers.state?void 0:watchers.state.checkout)||void 0===i?void 0:i.id,data:{status:"draft",refresh_price_versions:!0}})}async initialize(e={}){let t=this.addInitialPrices()||[];return t=this.addPriceChoices(t),(null==t?void 0:t.length)?this.loadUpdate({line_items:t,...e}):this.loadUpdate({...e})}addInitialPrices(){var e;return(null===(e=null==this?void 0:this.prices)||void 0===e?void 0:e.length)?this.prices.some((e=>!(null==e?void 0:e.id)))?void 0:this.prices.map((e=>({price_id:e.id,quantity:e.quantity}))):[]}addPriceChoices(e=[]){return this.el.querySelectorAll("[price-id]").forEach((t=>{t.checked&&e.push({quantity:t.quantity||1,price_id:t.priceId,...t.defaultAmount?{ad_hoc_amount:t.defaultAmount}:{}}),t.defaultAmount&&e.push({quantity:t.quantity||1,price_id:t.priceId,ad_hoc_amount:t.defaultAmount})})),e}getSessionId(){var e,t;return getQueryArg.getQueryArg(window.location.href,"checkout_id")||((null===(e=null===watchers.state||void 0===watchers.state?void 0:watchers.state.checkout)||void 0===e?void 0:e.id)?null===(t=null===watchers.state||void 0===watchers.state?void 0:watchers.state.checkout)||void 0===t?void 0:t.id:null)}async fetchCheckout(e,{query:t={},data:r={}}={}){try{updateFormState("FETCH");const i=await index$1.createOrUpdateCheckout({id:e,query:t,data:r});return updateFormState("RESOLVE"),i}catch(e){this.handleErrorResponse(e)}}async fetch(e={}){try{updateFormState("FETCH"),watchers.state.checkout=await index$1.fetchCheckout({id:this.getSessionId(),query:e}),updateFormState("RESOLVE")}catch(e){this.handleErrorResponse(e)}}async update(e={},t={}){try{watchers.state.checkout=await index$1.createOrUpdateCheckout({id:(null==e?void 0:e.id)?e.id:this.getSessionId(),data:e,query:t})}catch(e){if(["checkout.not_found"].includes(null==e?void 0:e.code))return mutations.clearCheckout(),this.initialize();throw console.error(e),e}}async loadUpdate(e={}){try{updateFormState("FETCH"),await this.update(e),updateFormState("RESOLVE")}catch(e){this.handleErrorResponse(e)}}render(){return index.h("sc-line-items-provider",{order:null===watchers.state||void 0===watchers.state?void 0:watchers.state.checkout,onScUpdateLineItems:e=>this.loadUpdate({line_items:e.detail})},index.h("slot",null))}get el(){return index.getElement(this)}static get watchers(){return{prices:["handlePricesChange"]}}};exports.sc_checkout_unsaved_changes_warning=ScCheckoutUnsavedChangesWarning,exports.sc_form_components_validator=ScFormComponentsValidator,exports.sc_form_error_provider=ScFormErrorProvider,exports.sc_form_state_provider=ScFormStateProvider,exports.sc_login_provider=ScLoginProvider,exports.sc_order_confirm_provider=ScOrderConfirmProvider,exports.sc_session_provider=ScSessionProvider;