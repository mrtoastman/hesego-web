import{r as i,h as t}from"./p-dfbe004d.js";import{U as s}from"./p-c7dd942d.js";import{c as o}from"./p-afcbd440.js";import{c as r}from"./p-ec9ca067.js";import{g as n,s as d}from"./p-10aa7556.js";import{u as e}from"./p-57d82274.js";import"./p-47d251a3.js";import"./p-ea78c070.js";import"./p-35c4916d.js";import"./p-0bb69f38.js";import"./p-9b6c2663.js";import"./p-d8453138.js";import"./p-1c2e2695.js";import"./p-4d73f82a.js";const a={expand:["line_items","line_item.price","price.product","customer","customer.shipping_address","payment_intent","discount","discount.promotion","discount.coupon","shipping_address","tax_identifier"]},l=class{constructor(t){i(this,t),this.quantity=1,this.mode="live"}getLineItem(){var t,i;const r=this.getOrder(),o=((null===(t=null==r?void 0:r.line_items)||void 0===t?void 0:t.data)||[]).find((t=>{var i;return(null===(i=t.price)||void 0===i?void 0:i.id)===this.priceId}));return!!(null==o?void 0:o.id)&&{id:null==o?void 0:o.id,price_id:null===(i=null==o?void 0:o.price)||void 0===i?void 0:i.id,quantity:null==o?void 0:o.quantity}}getOrder(){return n(null==this?void 0:this.formId,this.mode)}async addToCart(){const{price:t}=await this.form.getFormJson();try{this.busy=!0;const i=await this.addOrUpdateLineItem({...t?{ad_hoc_amount:parseInt(t)||null}:{}});d(i,this.formId),e.set("cart",{...e.state.cart,open:!0})}catch(t){console.error(t),this.error=(null==t?void 0:t.message)||wp.i18n.__("Something went wrong","surecart")}finally{this.busy=!1}}async addOrUpdateLineItem(t={}){var i,e;let s=this.getLineItem(),d=o((null===(i=this.getOrder())||void 0===i?void 0:i.line_items)||[]);return await r({id:null===(e=this.getOrder())||void 0===e?void 0:e.id,data:{live_mode:"live"===this.mode,line_items:[...(d||[]).map((i=>this.priceId===(null==i?void 0:i.price_id)?{...i,...(null==t?void 0:t.ad_hoc_amount)?{ad_hoc_amount:null==t?void 0:t.ad_hoc_amount}:{},quantity:(null==i?void 0:i.ad_hoc_amount)?1:(null==i?void 0:i.quantity)+1}:i)),...s?[]:[{price_id:this.priceId,...(null==t?void 0:t.ad_hoc_amount)?{ad_hoc_amount:null==t?void 0:t.ad_hoc_amount}:{},quantity:1}]]},query:{...a,form_id:this.formId}})}componentWillLoad(){s.create(this,this.state())}state(){return{busy:this.busy,error:this.error,order:this.getOrder()}}render(){return t("sc-form",{ref:t=>this.form=t,onScSubmit:()=>{this.addToCart()}},this.error&&t("sc-alert",{open:!!this.error,type:"danger"},t("span",{slot:"title"},wp.i18n.__("Error","surecart")),this.error),t(s.Provider,{state:this.state()},t("slot",null)))}};l.style="sc-cart-form { display: inline-block }";export{l as sc_cart_form};