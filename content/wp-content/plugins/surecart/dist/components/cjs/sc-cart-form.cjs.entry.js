"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const index=require("./index-9c866aeb.js"),universe=require("./universe-28bdab41.js"),index$1=require("./index-cf22257b.js"),index$2=require("./index-2840f0ff.js"),watchers=require("./watchers-203d7acd.js"),ui=require("./ui-180b96fe.js");require("./watchers-be62d6ad.js"),require("./watchers-d5742848.js"),require("./index-f6f80680.js"),require("./getters-c6087113.js"),require("./util-98cb3494.js"),require("./fetch-b673a242.js"),require("./add-query-args-17c551b6.js"),require("./get-query-arg-53bf21e2.js");const query={expand:["line_items","line_item.price","price.product","customer","customer.shipping_address","payment_intent","discount","discount.promotion","discount.coupon","shipping_address","tax_identifier"]},ScCartForm=class{constructor(e){index.registerInstance(this,e),this.quantity=1,this.mode="live"}getLineItem(){var e,i;const r=this.getOrder(),t=((null===(e=null==r?void 0:r.line_items)||void 0===e?void 0:e.data)||[]).find((e=>{var i;return(null===(i=e.price)||void 0===i?void 0:i.id)===this.priceId}));return!!(null==t?void 0:t.id)&&{id:null==t?void 0:t.id,price_id:null===(i=null==t?void 0:t.price)||void 0===i?void 0:i.id,quantity:null==t?void 0:t.quantity}}getOrder(){return watchers.getOrder(null==this?void 0:this.formId,this.mode)}async addToCart(){const{price:e}=await this.form.getFormJson();try{this.busy=!0;const i=await this.addOrUpdateLineItem({...e?{ad_hoc_amount:parseInt(e)||null}:{}});watchers.setOrder(i,this.formId),ui.uiStore.set("cart",{...ui.uiStore.state.cart,open:!0})}catch(e){console.error(e),this.error=(null==e?void 0:e.message)||wp.i18n.__("Something went wrong","surecart")}finally{this.busy=!1}}async addOrUpdateLineItem(e={}){var i,r;let t=this.getLineItem(),s=index$1.convertLineItemsToLineItemData((null===(i=this.getOrder())||void 0===i?void 0:i.line_items)||[]);return await index$2.createOrUpdateCheckout({id:null===(r=this.getOrder())||void 0===r?void 0:r.id,data:{live_mode:"live"===this.mode,line_items:[...(s||[]).map((i=>this.priceId===(null==i?void 0:i.price_id)?{...i,...(null==e?void 0:e.ad_hoc_amount)?{ad_hoc_amount:null==e?void 0:e.ad_hoc_amount}:{},quantity:(null==i?void 0:i.ad_hoc_amount)?1:(null==i?void 0:i.quantity)+1}:i)),...t?[]:[{price_id:this.priceId,...(null==e?void 0:e.ad_hoc_amount)?{ad_hoc_amount:null==e?void 0:e.ad_hoc_amount}:{},quantity:1}]]},query:{...query,form_id:this.formId}})}componentWillLoad(){universe.Universe.create(this,this.state())}state(){return{busy:this.busy,error:this.error,order:this.getOrder()}}render(){return index.h("sc-form",{ref:e=>this.form=e,onScSubmit:()=>{this.addToCart()}},this.error&&index.h("sc-alert",{open:!!this.error,type:"danger"},index.h("span",{slot:"title"},wp.i18n.__("Error","surecart")),this.error),index.h(universe.Universe.Provider,{state:this.state()},index.h("slot",null)))}};ScCartForm.style="sc-cart-form { display: inline-block }",exports.sc_cart_form=ScCartForm;