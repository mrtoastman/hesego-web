import{r as registerInstance,h}from"./index-fd4790f6.js";import{U as Universe}from"./universe-e944e399.js";import{c as convertLineItemsToLineItemData}from"./index-1ef9aa85.js";import{c as createOrUpdateCheckout}from"./index-93eba176.js";import{g as getOrder,s as setOrder}from"./watchers-0c79cf4e.js";import{u as uiStore}from"./ui-bfbc2b0b.js";import"./watchers-0c38e1b1.js";import"./watchers-e86a5dda.js";import"./index-26bbcef3.js";import"./getters-c6fb954d.js";import"./util-1396ff7b.js";import"./fetch-34712ac6.js";import"./add-query-args-f4c5962b.js";import"./get-query-arg-cb6b8763.js";const query={expand:["line_items","line_item.price","price.product","customer","customer.shipping_address","payment_intent","discount","discount.promotion","discount.coupon","shipping_address","tax_identifier"]},ScCartForm=class{constructor(t){registerInstance(this,t),this.quantity=1,this.mode="live"}getLineItem(){var t,e;const r=this.getOrder(),i=((null===(t=null==r?void 0:r.line_items)||void 0===t?void 0:t.data)||[]).find((t=>{var e;return(null===(e=t.price)||void 0===e?void 0:e.id)===this.priceId}));return!!(null==i?void 0:i.id)&&{id:null==i?void 0:i.id,price_id:null===(e=null==i?void 0:i.price)||void 0===e?void 0:e.id,quantity:null==i?void 0:i.quantity}}getOrder(){return getOrder(null==this?void 0:this.formId,this.mode)}async addToCart(){const{price:t}=await this.form.getFormJson();try{this.busy=!0;const e=await this.addOrUpdateLineItem({...t?{ad_hoc_amount:parseInt(t)||null}:{}});setOrder(e,this.formId),uiStore.set("cart",{...uiStore.state.cart,open:!0})}catch(t){console.error(t),this.error=(null==t?void 0:t.message)||wp.i18n.__("Something went wrong","surecart")}finally{this.busy=!1}}async addOrUpdateLineItem(t={}){var e,r;let i=this.getLineItem(),o=convertLineItemsToLineItemData((null===(e=this.getOrder())||void 0===e?void 0:e.line_items)||[]);return await createOrUpdateCheckout({id:null===(r=this.getOrder())||void 0===r?void 0:r.id,data:{live_mode:"live"===this.mode,line_items:[...(o||[]).map((e=>this.priceId===(null==e?void 0:e.price_id)?{...e,...(null==t?void 0:t.ad_hoc_amount)?{ad_hoc_amount:null==t?void 0:t.ad_hoc_amount}:{},quantity:(null==e?void 0:e.ad_hoc_amount)?1:(null==e?void 0:e.quantity)+1}:e)),...i?[]:[{price_id:this.priceId,...(null==t?void 0:t.ad_hoc_amount)?{ad_hoc_amount:null==t?void 0:t.ad_hoc_amount}:{},quantity:1}]]},query:{...query,form_id:this.formId}})}componentWillLoad(){Universe.create(this,this.state())}state(){return{busy:this.busy,error:this.error,order:this.getOrder()}}render(){return h("sc-form",{ref:t=>this.form=t,onScSubmit:()=>{this.addToCart()}},this.error&&h("sc-alert",{open:!!this.error,type:"danger"},h("span",{slot:"title"},wp.i18n.__("Error","surecart")),this.error),h(Universe.Provider,{state:this.state()},h("slot",null)))}};ScCartForm.style="sc-cart-form { display: inline-block }";export{ScCartForm as sc_cart_form};