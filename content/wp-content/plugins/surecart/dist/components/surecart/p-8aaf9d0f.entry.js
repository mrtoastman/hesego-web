import{r as t,h as i,g as s,c as e,H as o}from"./p-dfbe004d.js";import{s as n,v as r,c as a}from"./p-75c9e181.js";import{a as d}from"./p-d8453138.js";import{e as l,f as c,a as h,c as u}from"./p-ec9ca067.js";import{a as v,r as p}from"./p-10aa7556.js";import{c as m}from"./p-30ecac60.js";import{a as g,g as w}from"./p-1c2e2695.js";import{s as y}from"./p-ea78c070.js";import{p as f}from"./p-f1a6f9ec.js";import{g as _}from"./p-4d73f82a.js";import"./p-35c4916d.js";import"./p-47d251a3.js";import"./p-0bb69f38.js";import"./p-9b6c2663.js";const E=class{constructor(e){t(this,e)}componentDidLoad(){window.addEventListener("beforeunload",(e=>this.warnIfUnsavedChanges(e)),{capture:!0})}warnIfUnsavedChanges(e){if(["updating","finalizing","confirming"].includes(this.state))return console.log({e:e}),e.preventDefault(),e.returnValue=wp.i18n.__("Your payment is processing. Exiting this page could cause an error in your order. Please do not navigate away from this page.","surecart"),e.returnValue}},C=class{constructor(e){t(this,e)}handleOrderChange(){var e,t,i,s,o,r;this.disabled||(("address_invalid"===(null===(e=null==this?void 0:this.order)||void 0===e?void 0:e.tax_status)||(null===(t=null==this?void 0:this.order)||void 0===t?void 0:t.shipping_enabled))&&this.addAddressField(),(null===(o=null===(s=null===(i=null==this?void 0:this.order)||void 0===i?void 0:i.recommended_bumps)||void 0===s?void 0:s.data)||void 0===o?void 0:o.length)&&this.addBumps(),(null===(r=this.order)||void 0===r?void 0:r.tax_amount)&&this.addTaxLine())}componentWillLoad(){var e,t;this.hasAddress=!!this.el.querySelector("sc-order-shipping-address"),this.hasTaxIDField=!!this.el.querySelector("sc-order-tax-id-input"),this.hasBumpsField=!!this.el.querySelector("sc-order-bumps"),this.hasTaxLine=!!this.el.querySelector("sc-line-item-tax"),(null===(e=this.taxProtocol)||void 0===e?void 0:e.tax_enabled)&&(this.addAddressField(),(null===(t=this.taxProtocol)||void 0===t?void 0:t.eu_vat_required)&&this.addTaxIDField()),this.handleOrderChange()}addAddressField(){if(this.hasAddress)return;const e=this.el.querySelector("sc-payment"),t=document.createElement("sc-order-shipping-address");t.label=wp.i18n.__("Address","surecart"),e.parentNode.insertBefore(t,e),this.hasAddress=!0}addTaxIDField(){if(this.hasTaxIDField)return;const e=this.el.querySelector("sc-payment"),t=document.createElement("sc-order-tax-id-input");e.parentNode.insertBefore(t,e),this.hasTaxIDField=!0}addBumps(){if(this.hasBumpsField)return;const e=this.el.querySelector("sc-payment"),t=document.createElement("sc-order-bumps");e.parentNode.insertBefore(t,e.nextSibling),this.hasBumpsField=!0}addTaxLine(){var e;if(this.hasTaxLine)return;const t=this.el.querySelector("sc-line-item-total[total=total]"),i=document.createElement("sc-line-item-tax");"SC-DIVIDER"===(null===(e=null==t?void 0:t.previousElementSibling)||void 0===e?void 0:e.tagName)?t.parentNode.insertBefore(i,t.previousElementSibling):t.parentNode.insertBefore(i,t),this.hasTaxLine=!0}render(){return i("slot",null)}get el(){return s(this)}static get watchers(){return{order:["handleOrderChange"]}}},S=class{constructor(i){t(this,i),this.scUpdateError=e(this,"scUpdateError",7),this.scSetState=e(this,"scSetState",7)}handleErrorUpdate(e){this.scUpdateError.emit(e)}handleStateChange(e){["finalizing","updating"].includes(e)&&(this.error=null)}handleErrorEvent(e){this.error=e.detail,Object.keys((null==e?void 0:e.detail)||{}).length&&this.scSetState.emit("REJECT")}handlePayError(e){var t;this.error=(null===(t=e.detail)||void 0===t?void 0:t.message)||{code:"",message:"Something went wrong with your payment."}}componentWillLoad(){this.maybeAddErrorsComponent()}maybeAddErrorsComponent(){if(this.el.querySelector("sc-checkout-form-errors"))return;const e=document.createElement("sc-checkout-form-errors");console.log(this.el.querySelector("sc-form")),this.el.querySelector("sc-form").prepend(e)}render(){return i("slot",null)}get el(){return s(this)}static get watchers(){return{error:["handleErrorUpdate"],checkoutState:["handleStateChange"]}}},b=r(a);b.subscribe((e=>n.formState=e)),b.start();const{send:k}=b,P=e=>k(e),I=class{constructor(i){t(this,i),this.scSetCheckoutFormState=e(this,"scSetCheckoutFormState",7),this._stateService=r(a),this.checkoutState=a.initialState}setState(e){const{send:t}=this._stateService;return P(e),t(e)}handleCheckoutStateChange(e){this.scSetCheckoutFormState.emit(e.value)}componentWillLoad(){this._stateService.subscribe((e=>this.checkoutState=e)),this._stateService.start()}disconnectedCallback(){this._stateService.stop()}handleSetStateEvent(e){this.setState(e.detail)}async handlePaid(){this.setState("PAID")}render(){return"expired"===this.checkoutState.value?i("sc-block-ui",null,i("div",null,wp.i18n.__("Please refresh the page.","surecart"))):i("slot",null)}static get watchers(){return{checkoutState:["handleCheckoutStateChange"]}}},x=class{constructor(i){t(this,i),this.scSetLoggedIn=e(this,"scSetLoggedIn",7),this.scSetCustomer=e(this,"scSetCustomer",7)}handleLoginPrompt(){this.open=!0}handleLoginDialogChange(e){e&&setTimeout((()=>{this.loginForm.querySelector("sc-input").triggerFocus()}),100)}handleLoggedInChange(e,t){!1===t&&e&&(this.notice=!0)}handleOrderChange(e,t){(null==e?void 0:e.updated_at)!==(null==t?void 0:t.updated_at)&&(this.notice=!1)}async handleFormSubmit(e){e.preventDefault(),e.stopImmediatePropagation(),this.error=null;const{login:t,password:i}=await e.target.getFormJson();try{this.loading=!0;const{name:e,email:s}=await d({method:"POST",path:"surecart/v1/login",data:{login:t,password:i}});this.scSetLoggedIn.emit(!0),this.scSetCustomer.emit({name:e,email:s}),this.open=!1}catch(e){console.error(e),this.error=(null==e?void 0:e.message)||wp.i18n.__("Something went wrong","surecart")}finally{this.loading=!1}}render(){return i(o,null,!!this.notice&&i("sc-alert",{type:"success",open:!0,style:{marginBottom:"var(--sc-form-row-spacing)"},closable:!0},i("span",{slot:"title"},wp.i18n.__("Welcome back!","surecart")),wp.i18n.__("You have logged in successfully.","surecart")),i("slot",null),!this.loggedIn&&i("sc-dialog",{label:wp.i18n.__("Login to your account","surecart"),open:this.open,onScRequestClose:()=>this.open=!1},i("sc-form",{ref:e=>this.loginForm=e,onScFormSubmit:e=>{e.preventDefault(),e.stopImmediatePropagation()},onScSubmit:e=>this.handleFormSubmit(e)},!!this.error&&i("sc-alert",{type:"danger",open:!!this.error},this.error),i("sc-input",{label:wp.i18n.__("Email or Username","surecart"),type:"text",name:"login",required:!0,autofocus:this.open}),i("sc-input",{label:wp.i18n.__("Password","surecart"),type:"password",name:"password",required:!0}),i("sc-button",{type:"primary",full:!0,loading:this.loading,submit:!0},wp.i18n.__("Login","surecart")))))}static get watchers(){return{open:["handleLoginDialogChange"],loggedIn:["handleLoggedInChange"],order:["handleOrderChange"]}}};x.style=":host{display:block}";const L=class{constructor(i){t(this,i),this.scOrderPaid=e(this,"scOrderPaid",7),this.scSetState=e(this,"scSetState",7),this.scError=e(this,"scError",7),this.showSuccessModal=!1}handlePaidEvent(){this.confirmOrder()}async confirmOrder(){var e,t,i;try{this.confirmedCheckout=await d({method:"PATCH",path:g(`surecart/v1/checkouts/${null===(e=null==v?void 0:v.checkout)||void 0===e?void 0:e.id}/confirm`,[l])}),this.scSetState.emit("CONFIRMED"),this.scOrderPaid.emit(this.confirmedCheckout)}catch(e){console.error(e),this.scError.emit(e)}finally{m();const e=(null===(i=null===(t=this.confirmedCheckout)||void 0===t?void 0:t.metadata)||void 0===i?void 0:i.success_url)||this.successUrl;e?(this.scSetState.emit("REDIRECT"),setTimeout((()=>{var t;return window.location.assign(g(e,{order:null===(t=this.confirmedCheckout)||void 0===t?void 0:t.id}))}),50)):this.showSuccessModal=!0}}getSuccessUrl(){var e,t,i,s,o;const r=(null===(t=null===(e=this.confirmedCheckout)||void 0===e?void 0:e.metadata)||void 0===t?void 0:t.success_url)||this.successUrl;return r?g(r,{order:null===(i=this.confirmedCheckout)||void 0===i?void 0:i.id}):null===(o=null===(s=null===window||void 0===window?void 0:window.scData)||void 0===s?void 0:s.pages)||void 0===o?void 0:o.dashboard}render(){var e,t,s,r;const n=null===(e=this.confirmedCheckout)||void 0===e?void 0:e.manual_payment_method;return i(o,null,i("slot",null),i("sc-dialog",{open:!!this.showSuccessModal,style:{"--body-spacing":"var(--sc-spacing-xxx-large)"},noHeader:!0,onScRequestClose:e=>e.preventDefault()},i("div",{class:"confirm__icon"},i("div",{class:"confirm__icon-container"},i("sc-icon",{name:"check"}))),i("sc-dashboard-module",{heading:(null===(t=this.successText)||void 0===t?void 0:t.title)||wp.i18n.__("Thanks for your order!","surecart"),style:{"--sc-dashboard-module-spacing":"var(--sc-spacing-x-large)",textAlign:"center"}},i("span",{slot:"description"},(null===(s=this.successText)||void 0===s?void 0:s.description)||wp.i18n.__("Your payment was successful, and your order is complete. A receipt is on its way to your inbox.","surecart")),!!(null==n?void 0:n.name)&&!!(null==n?void 0:n.instructions)&&i("sc-alert",{type:"info",open:!0,style:{"text-align":"left"}},i("span",{slot:"title"},null==n?void 0:n.name),null==n?void 0:n.instructions.split("\n").map((e=>i("p",null,e)))),i("sc-button",{href:this.getSuccessUrl(),size:"large",type:"primary"},(null===(r=this.successText)||void 0===r?void 0:r.button)||wp.i18n.__("Continue","surecart"),i("sc-icon",{name:"arrow-right",slot:"suffix"})))))}get el(){return s(this)}};L.style=".confirm__icon{margin-bottom:var(--sc-spacing-medium);display:flex;justify-content:center}.confirm__icon-container{background:var(--sc-color-primary-500);width:55px;height:55px;border-radius:999999px;display:flex;align-items:center;justify-content:center;font-size:26px;line-height:1;color:white}sc-dialog::part(overlay){backdrop-filter:blur(4px)}";const T=class{constructor(i){t(this,i),this.scUpdateOrderState=e(this,"scUpdateOrderState",7),this.scUpdateDraftState=e(this,"scUpdateDraftState",7),this.scPaid=e(this,"scPaid",7),this.scError=e(this,"scError",7),this.scSetState=e(this,"scSetState",7),this.prices=[],this.persist=!0}handlePricesChange(){let e=this.addInitialPrices()||[];if(e=this.addPriceChoices(e),null==e?void 0:e.length)return this.loadUpdate({line_items:e})}async finalize(){return await this.handleFormSubmit()}async getFormData(){let e={};const t=this.el.querySelector("sc-form");if(t){const i=await t.getFormJson();e=f(i)}return e}async handleFormSubmit(){var e,t,i,s,o,r,n,a,d;this.scError.emit({}),P("FINALIZE");let l=await this.getFormData();if((null===(e=null===window||void 0===window?void 0:window.scData)||void 0===e?void 0:e.recaptcha_site_key)&&(null===window||void 0===window?void 0:window.grecaptcha))try{l.grecaptcha=await window.grecaptcha.execute(window.scData.recaptcha_site_key,{action:"surecart_checkout_submit"})}catch(e){return console.error(e),P("REJECT"),void this.handleErrorResponse(e)}try{await this.update(l)}catch(e){console.error(e),P("REJECT"),this.handleErrorResponse(e)}try{return v.checkout=await c({id:null===(t=null==v?void 0:v.checkout)||void 0===t?void 0:t.id,query:{...(null==y?void 0:y.method)?{payment_method_type:null==y?void 0:y.method}:{},return_url:g(window.location.href,{...(null===(i=null==v?void 0:v.checkout)||void 0===i?void 0:i.id)?{checkout_id:null===(s=null==v?void 0:v.checkout)||void 0===s?void 0:s.id}:{},is_surecart_payment_redirect:!0})},data:l,processor:{id:y.id,manual:y.manual}}),["paid","processing"].includes(null===(o=v.checkout)||void 0===o?void 0:o.status)&&this.scPaid.emit(),(null===(d=null===(a=null===(n=null===(r=v.checkout)||void 0===r?void 0:r.payment_intent)||void 0===n?void 0:n.processor_data)||void 0===a?void 0:a.mollie)||void 0===d?void 0:d.checkout_url)?(P("PAYING"),setTimeout((()=>{var e,t,i,s;return window.location.assign(null===(s=null===(i=null===(t=null===(e=v.checkout)||void 0===e?void 0:e.payment_intent)||void 0===t?void 0:t.processor_data)||void 0===i?void 0:i.mollie)||void 0===s?void 0:s.checkout_url)}),50)):(setTimeout((()=>{P("PAYING")}),50),v.checkout)}catch(e){console.error(e),this.handleErrorResponse(e)}}async handlePaid(){P("PAID")}async handlePayError(){P("REJECT")}async handleAbandonedCartUpdate(e){this.loadUpdate({abandoned_checkout_enabled:e.detail})}async handleCouponApply(e){const t=e.detail;this.scError.emit({}),this.loadUpdate({discount:{...t?{promotion_code:t}:{}}})}componentDidLoad(){this.findOrCreateOrder()}async findOrCreateOrder(){var e;const{redirect_status:t,checkout_id:i,line_items:s,coupon:o,is_surecart_payment_redirect:r}=w(window.location.href);if(window.history.replaceState({},document.title,p(window.location.href,"redirect_status","coupon","line_items","confirm_checkout_id","checkout_id")),r&&i)return P("FINALIZE"),P("PAYING"),this.handleCheckoutIdFromUrl(i,o);if(t)return this.handleRedirectStatus(t,i);if(i)return this.handleCheckoutIdFromUrl(i,o);if(s)return this.handleInitialLineItems(s,o);const n=null===(e=null==v?void 0:v.checkout)||void 0===e?void 0:e.id;return n&&this.persist?this.handleExistingCheckout(n,o):this.handleNewCheckout(o)}async handleRedirectStatus(e,t){var i,s;if(console.info("Handling payment redirect."),"failed"===e)return this.scError.emit({message:wp.i18n.__("Payment unsuccessful. Please try again.","surecart")});if(!t)return this.scError.emit({message:wp.i18n.__("Could not find checkout. Please contact us before attempting to purchase again.","surecart")});try{P("FINALIZE"),P("PAID"),v.checkout=await h({id:t,query:{refresh_status:!0}}),(null===(i=v.checkout)||void 0===i?void 0:i.status)&&["paid","processing"].includes(null===(s=v.checkout)||void 0===s?void 0:s.status)&&setTimeout((()=>{this.scPaid.emit()}),100)}catch(e){this.handleErrorResponse(e)}}async handleCheckoutIdFromUrl(e,t=""){var i;if(console.info("Handling existing checkout from url.",t,e),t)return this.loadUpdate({id:e,discount:{promotion_code:t}});try{P("FETCH"),v.checkout=await h({id:e,query:{refresh_status:!0}}),P("RESOLVE")}catch(e){this.handleErrorResponse(e)}switch(null===(i=v.checkout)||void 0===i?void 0:i.status){case"paid":case"processing":return setTimeout((()=>{P("FINALIZE"),P("PAID"),this.scPaid.emit()}),100);case"payment_failed":return m(),this.scError.emit({message:wp.i18n.__("Payment unsuccessful. Please try again.","surecart")});case"payment_intent_canceled":case"canceled":return m(),this.scError.emit({message:wp.i18n.__("Payment canceled. Please try again.","surecart")});case"finalized":this.scError.emit({message:wp.i18n.__("Payment unsuccessful. Please try again.","surecart")}),P("REJECT")}}async handleInitialLineItems(e,t){console.info("Handling initial line items.");const i=this.el.querySelector("sc-order-shipping-address");return m(),this.loadUpdate({line_items:e,...t?{discount:{promotion_code:t}}:{},...(null==i?void 0:i.defaultCountry)?{shipping_address:{country:null==i?void 0:i.defaultCountry}}:{}})}async handleNewCheckout(e){console.info("Handling new checkout.");const t=this.getFormData(),i=this.addPriceChoices(this.addInitialPrices()||[]),s=this.el.querySelector("sc-order-shipping-address");try{P("FETCH"),v.checkout=await u({data:{...t,...e?{discount:{promotion_code:e}}:{},...(null==s?void 0:s.defaultCountry)?{shipping_address:{country:null==s?void 0:s.defaultCountry}}:{},line_items:i}}),P("RESOLVE")}catch(e){console.error(e),this.handleErrorResponse(e)}}async handleExistingCheckout(e,t){if(!e)return this.handleNewCheckout(t);console.info("Handling existing checkout.");try{P("FETCH"),v.checkout=await u({id:e,data:{...t?{discount:{promotion_code:t}}:{}}}),P("RESOLVE")}catch(e){console.error(e),this.handleErrorResponse(e)}}async handleErrorResponse(e){var t,i,s,o;if(["checkout.not_found"].includes(null==e?void 0:e.code))return window.history.replaceState({},document.title,p(window.location.href,"checkout_id")),m(),this.handleNewCheckout(!1);if("order.line_items.old_price_versions"!==(null===(i=null===(t=null==e?void 0:e.additional_errors)||void 0===t?void 0:t[0])||void 0===i?void 0:i.code)){if(["order.invalid_status_transition"].includes(null==e?void 0:e.code))return await this.loadUpdate({id:null===(o=null==v?void 0:v.checkout)||void 0===o?void 0:o.id,data:{status:"draft"}}),void this.handleFormSubmit();if("rest_cookie_invalid_nonce"!==(null==e?void 0:e.code)){if("readonly"===(null==e?void 0:e.code))return m(),void window.location.assign(p(window.location.href,"order"));console.log("emit",e),this.scError.emit(e),P("REJECT")}else P("EXPIRE")}else await this.loadUpdate({id:null===(s=null==v?void 0:v.checkout)||void 0===s?void 0:s.id,data:{status:"draft",refresh_price_versions:!0}})}async initialize(e={}){let t=this.addInitialPrices()||[];return t=this.addPriceChoices(t),this.loadUpdate((null==t?void 0:t.length)?{line_items:t,...e}:{...e})}addInitialPrices(){var e;return(null===(e=null==this?void 0:this.prices)||void 0===e?void 0:e.length)?this.prices.some((e=>!(null==e?void 0:e.id)))?void 0:this.prices.map((e=>({price_id:e.id,quantity:e.quantity}))):[]}addPriceChoices(e=[]){return this.el.querySelectorAll("[price-id]").forEach((t=>{t.checked&&e.push({quantity:t.quantity||1,price_id:t.priceId,...t.defaultAmount?{ad_hoc_amount:t.defaultAmount}:{}}),t.defaultAmount&&e.push({quantity:t.quantity||1,price_id:t.priceId,ad_hoc_amount:t.defaultAmount})})),e}getSessionId(){var e,t;return _(window.location.href,"checkout_id")||((null===(e=null==v?void 0:v.checkout)||void 0===e?void 0:e.id)?null===(t=null==v?void 0:v.checkout)||void 0===t?void 0:t.id:null)}async fetchCheckout(e,{query:t={},data:i={}}={}){try{P("FETCH");const s=await u({id:e,query:t,data:i});return P("RESOLVE"),s}catch(e){this.handleErrorResponse(e)}}async fetch(e={}){try{P("FETCH"),v.checkout=await h({id:this.getSessionId(),query:e}),P("RESOLVE")}catch(e){this.handleErrorResponse(e)}}async update(e={},t={}){try{v.checkout=await u({id:(null==e?void 0:e.id)?e.id:this.getSessionId(),data:e,query:t})}catch(e){if(["checkout.not_found"].includes(null==e?void 0:e.code))return m(),this.initialize();throw console.error(e),e}}async loadUpdate(e={}){try{P("FETCH"),await this.update(e),P("RESOLVE")}catch(e){this.handleErrorResponse(e)}}render(){return i("sc-line-items-provider",{order:null==v?void 0:v.checkout,onScUpdateLineItems:e=>this.loadUpdate({line_items:e.detail})},i("slot",null))}get el(){return s(this)}static get watchers(){return{prices:["handlePricesChange"]}}};export{E as sc_checkout_unsaved_changes_warning,C as sc_form_components_validator,S as sc_form_error_provider,I as sc_form_state_provider,x as sc_login_provider,L as sc_order_confirm_provider,T as sc_session_provider};