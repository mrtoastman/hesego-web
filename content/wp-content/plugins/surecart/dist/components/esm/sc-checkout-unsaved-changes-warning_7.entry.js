import{r as registerInstance,h,g as getElement,c as createEvent,H as Host}from"./index-fd4790f6.js";import{s as state,v,c as checkoutMachine}from"./store-3645d641.js";import{a as apiFetch}from"./fetch-34712ac6.js";import{e as expand,f as finalizeCheckout,a as fetchCheckout,c as createOrUpdateCheckout}from"./index-93eba176.js";import{a as state$1,r as removeQueryArgs}from"./watchers-0c79cf4e.js";import{c as clearCheckout}from"./mutations-8030ef46.js";import{a as addQueryArgs,g as getQueryArgs}from"./add-query-args-f4c5962b.js";import{s as state$2}from"./watchers-e86a5dda.js";import{p as parseFormData}from"./form-data-2d60f23e.js";import{g as getQueryArg}from"./get-query-arg-cb6b8763.js";import"./index-26bbcef3.js";import"./watchers-0c38e1b1.js";import"./getters-c6fb954d.js";import"./util-1396ff7b.js";const ScCheckoutUnsavedChangesWarning=class{constructor(e){registerInstance(this,e)}componentDidLoad(){window.addEventListener("beforeunload",(e=>this.warnIfUnsavedChanges(e)),{capture:!0})}warnIfUnsavedChanges(e){if(["updating","finalizing","confirming"].includes(this.state))return console.log({e:e}),e.preventDefault(),e.returnValue=wp.i18n.__("Your payment is processing. Exiting this page could cause an error in your order. Please do not navigate away from this page.","surecart"),e.returnValue}},ScFormComponentsValidator=class{constructor(e){registerInstance(this,e)}handleOrderChange(){var e,t,r,i,s,o;this.disabled||(("address_invalid"===(null===(e=null==this?void 0:this.order)||void 0===e?void 0:e.tax_status)||(null===(t=null==this?void 0:this.order)||void 0===t?void 0:t.shipping_enabled))&&this.addAddressField(),(null===(s=null===(i=null===(r=null==this?void 0:this.order)||void 0===r?void 0:r.recommended_bumps)||void 0===i?void 0:i.data)||void 0===s?void 0:s.length)&&this.addBumps(),(null===(o=this.order)||void 0===o?void 0:o.tax_amount)&&this.addTaxLine())}componentWillLoad(){var e,t;this.hasAddress=!!this.el.querySelector("sc-order-shipping-address"),this.hasTaxIDField=!!this.el.querySelector("sc-order-tax-id-input"),this.hasBumpsField=!!this.el.querySelector("sc-order-bumps"),this.hasTaxLine=!!this.el.querySelector("sc-line-item-tax"),(null===(e=this.taxProtocol)||void 0===e?void 0:e.tax_enabled)&&(this.addAddressField(),(null===(t=this.taxProtocol)||void 0===t?void 0:t.eu_vat_required)&&this.addTaxIDField()),this.handleOrderChange()}addAddressField(){if(this.hasAddress)return;const e=this.el.querySelector("sc-payment"),t=document.createElement("sc-order-shipping-address");t.label=wp.i18n.__("Address","surecart"),e.parentNode.insertBefore(t,e),this.hasAddress=!0}addTaxIDField(){if(this.hasTaxIDField)return;const e=this.el.querySelector("sc-payment"),t=document.createElement("sc-order-tax-id-input");e.parentNode.insertBefore(t,e),this.hasTaxIDField=!0}addBumps(){if(this.hasBumpsField)return;const e=this.el.querySelector("sc-payment"),t=document.createElement("sc-order-bumps");e.parentNode.insertBefore(t,e.nextSibling),this.hasBumpsField=!0}addTaxLine(){var e;if(this.hasTaxLine)return;const t=this.el.querySelector("sc-line-item-total[total=total]"),r=document.createElement("sc-line-item-tax");"SC-DIVIDER"===(null===(e=null==t?void 0:t.previousElementSibling)||void 0===e?void 0:e.tagName)?t.parentNode.insertBefore(r,t.previousElementSibling):t.parentNode.insertBefore(r,t),this.hasTaxLine=!0}render(){return h("slot",null)}get el(){return getElement(this)}static get watchers(){return{order:["handleOrderChange"]}}},ScFormErrorProvider=class{constructor(e){registerInstance(this,e),this.scUpdateError=createEvent(this,"scUpdateError",7),this.scSetState=createEvent(this,"scSetState",7)}handleErrorUpdate(e){this.scUpdateError.emit(e)}handleStateChange(e){["finalizing","updating"].includes(e)&&(this.error=null)}handleErrorEvent(e){this.error=e.detail,Object.keys((null==e?void 0:e.detail)||{}).length&&this.scSetState.emit("REJECT")}handlePayError(e){var t;this.error=(null===(t=e.detail)||void 0===t?void 0:t.message)||{code:"",message:"Something went wrong with your payment."}}componentWillLoad(){this.maybeAddErrorsComponent()}maybeAddErrorsComponent(){if(this.el.querySelector("sc-checkout-form-errors"))return;const e=document.createElement("sc-checkout-form-errors");console.log(this.el.querySelector("sc-form")),this.el.querySelector("sc-form").prepend(e)}render(){return h("slot",null)}get el(){return getElement(this)}static get watchers(){return{error:["handleErrorUpdate"],checkoutState:["handleStateChange"]}}},service=v(checkoutMachine);service.subscribe((e=>state.formState=e)),service.start();const{send:send}=service,updateFormState=e=>send(e),ScFormStateProvider=class{constructor(e){registerInstance(this,e),this.scSetCheckoutFormState=createEvent(this,"scSetCheckoutFormState",7),this._stateService=v(checkoutMachine),this.checkoutState=checkoutMachine.initialState}setState(e){const{send:t}=this._stateService;return updateFormState(e),t(e)}handleCheckoutStateChange(e){this.scSetCheckoutFormState.emit(e.value)}componentWillLoad(){this._stateService.subscribe((e=>this.checkoutState=e)),this._stateService.start()}disconnectedCallback(){this._stateService.stop()}handleSetStateEvent(e){this.setState(e.detail)}async handlePaid(){this.setState("PAID")}render(){return"expired"===this.checkoutState.value?h("sc-block-ui",null,h("div",null,wp.i18n.__("Please refresh the page.","surecart"))):h("slot",null)}static get watchers(){return{checkoutState:["handleCheckoutStateChange"]}}},scLoginProviderCss=":host{display:block}",ScLoginProvider=class{constructor(e){registerInstance(this,e),this.scSetLoggedIn=createEvent(this,"scSetLoggedIn",7),this.scSetCustomer=createEvent(this,"scSetCustomer",7)}handleLoginPrompt(){this.open=!0}handleLoginDialogChange(e){e&&setTimeout((()=>{this.loginForm.querySelector("sc-input").triggerFocus()}),100)}handleLoggedInChange(e,t){!1===t&&e&&(this.notice=!0)}handleOrderChange(e,t){(null==e?void 0:e.updated_at)!==(null==t?void 0:t.updated_at)&&(this.notice=!1)}async handleFormSubmit(e){e.preventDefault(),e.stopImmediatePropagation(),this.error=null;const{login:t,password:r}=await e.target.getFormJson();try{this.loading=!0;const{name:e,email:i}=await apiFetch({method:"POST",path:"surecart/v1/login",data:{login:t,password:r}});this.scSetLoggedIn.emit(!0),this.scSetCustomer.emit({name:e,email:i}),this.open=!1}catch(e){console.error(e),this.error=(null==e?void 0:e.message)||wp.i18n.__("Something went wrong","surecart")}finally{this.loading=!1}}render(){return h(Host,null,!!this.notice&&h("sc-alert",{type:"success",open:!0,style:{marginBottom:"var(--sc-form-row-spacing)"},closable:!0},h("span",{slot:"title"},wp.i18n.__("Welcome back!","surecart")),wp.i18n.__("You have logged in successfully.","surecart")),h("slot",null),!this.loggedIn&&h("sc-dialog",{label:wp.i18n.__("Login to your account","surecart"),open:this.open,onScRequestClose:()=>this.open=!1},h("sc-form",{ref:e=>this.loginForm=e,onScFormSubmit:e=>{e.preventDefault(),e.stopImmediatePropagation()},onScSubmit:e=>this.handleFormSubmit(e)},!!this.error&&h("sc-alert",{type:"danger",open:!!this.error},this.error),h("sc-input",{label:wp.i18n.__("Email or Username","surecart"),type:"text",name:"login",required:!0,autofocus:this.open}),h("sc-input",{label:wp.i18n.__("Password","surecart"),type:"password",name:"password",required:!0}),h("sc-button",{type:"primary",full:!0,loading:this.loading,submit:!0},wp.i18n.__("Login","surecart")))))}static get watchers(){return{open:["handleLoginDialogChange"],loggedIn:["handleLoggedInChange"],order:["handleOrderChange"]}}};ScLoginProvider.style=scLoginProviderCss;const scOrderConfirmProviderCss=".confirm__icon{margin-bottom:var(--sc-spacing-medium);display:flex;justify-content:center}.confirm__icon-container{background:var(--sc-color-primary-500);width:55px;height:55px;border-radius:999999px;display:flex;align-items:center;justify-content:center;font-size:26px;line-height:1;color:white}sc-dialog::part(overlay){backdrop-filter:blur(4px)}",ScOrderConfirmProvider=class{constructor(e){registerInstance(this,e),this.scOrderPaid=createEvent(this,"scOrderPaid",7),this.scSetState=createEvent(this,"scSetState",7),this.scError=createEvent(this,"scError",7),this.showSuccessModal=!1}handlePaidEvent(){this.confirmOrder()}async confirmOrder(){var e,t,r;try{this.confirmedCheckout=await apiFetch({method:"PATCH",path:addQueryArgs(`surecart/v1/checkouts/${null===(e=null==state$1?void 0:state$1.checkout)||void 0===e?void 0:e.id}/confirm`,[expand])}),this.scSetState.emit("CONFIRMED"),this.scOrderPaid.emit(this.confirmedCheckout)}catch(e){console.error(e),this.scError.emit(e)}finally{clearCheckout();const e=(null===(r=null===(t=this.confirmedCheckout)||void 0===t?void 0:t.metadata)||void 0===r?void 0:r.success_url)||this.successUrl;e?(this.scSetState.emit("REDIRECT"),setTimeout((()=>{var t;return window.location.assign(addQueryArgs(e,{order:null===(t=this.confirmedCheckout)||void 0===t?void 0:t.id}))}),50)):this.showSuccessModal=!0}}getSuccessUrl(){var e,t,r,i,s;const o=(null===(t=null===(e=this.confirmedCheckout)||void 0===e?void 0:e.metadata)||void 0===t?void 0:t.success_url)||this.successUrl;return o?addQueryArgs(o,{order:null===(r=this.confirmedCheckout)||void 0===r?void 0:r.id}):null===(s=null===(i=null===window||void 0===window?void 0:window.scData)||void 0===i?void 0:i.pages)||void 0===s?void 0:s.dashboard}render(){var e,t,r,i;const s=null===(e=this.confirmedCheckout)||void 0===e?void 0:e.manual_payment_method;return h(Host,null,h("slot",null),h("sc-dialog",{open:!!this.showSuccessModal,style:{"--body-spacing":"var(--sc-spacing-xxx-large)"},noHeader:!0,onScRequestClose:e=>e.preventDefault()},h("div",{class:"confirm__icon"},h("div",{class:"confirm__icon-container"},h("sc-icon",{name:"check"}))),h("sc-dashboard-module",{heading:(null===(t=this.successText)||void 0===t?void 0:t.title)||wp.i18n.__("Thanks for your order!","surecart"),style:{"--sc-dashboard-module-spacing":"var(--sc-spacing-x-large)",textAlign:"center"}},h("span",{slot:"description"},(null===(r=this.successText)||void 0===r?void 0:r.description)||wp.i18n.__("Your payment was successful, and your order is complete. A receipt is on its way to your inbox.","surecart")),!!(null==s?void 0:s.name)&&!!(null==s?void 0:s.instructions)&&h("sc-alert",{type:"info",open:!0,style:{"text-align":"left"}},h("span",{slot:"title"},null==s?void 0:s.name),null==s?void 0:s.instructions.split("\n").map((e=>h("p",null,e)))),h("sc-button",{href:this.getSuccessUrl(),size:"large",type:"primary"},(null===(i=this.successText)||void 0===i?void 0:i.button)||wp.i18n.__("Continue","surecart"),h("sc-icon",{name:"arrow-right",slot:"suffix"})))))}get el(){return getElement(this)}};ScOrderConfirmProvider.style=scOrderConfirmProviderCss;const ScSessionProvider=class{constructor(e){registerInstance(this,e),this.scUpdateOrderState=createEvent(this,"scUpdateOrderState",7),this.scUpdateDraftState=createEvent(this,"scUpdateDraftState",7),this.scPaid=createEvent(this,"scPaid",7),this.scError=createEvent(this,"scError",7),this.scSetState=createEvent(this,"scSetState",7),this.prices=[],this.persist=!0}handlePricesChange(){let e=this.addInitialPrices()||[];if(e=this.addPriceChoices(e),null==e?void 0:e.length)return this.loadUpdate({line_items:e})}async finalize(){return await this.handleFormSubmit()}async getFormData(){let e={};const t=this.el.querySelector("sc-form");if(t){const r=await t.getFormJson();e=parseFormData(r)}return e}async handleFormSubmit(){var e,t,r,i,s,o,a,n,c;this.scError.emit({}),updateFormState("FINALIZE");let d=await this.getFormData();if((null===(e=null===window||void 0===window?void 0:window.scData)||void 0===e?void 0:e.recaptcha_site_key)&&(null===window||void 0===window?void 0:window.grecaptcha))try{d.grecaptcha=await window.grecaptcha.execute(window.scData.recaptcha_site_key,{action:"surecart_checkout_submit"})}catch(e){return console.error(e),updateFormState("REJECT"),void this.handleErrorResponse(e)}try{await this.update(d)}catch(e){console.error(e),updateFormState("REJECT"),this.handleErrorResponse(e)}try{return state$1.checkout=await finalizeCheckout({id:null===(t=null==state$1?void 0:state$1.checkout)||void 0===t?void 0:t.id,query:{...(null==state$2?void 0:state$2.method)?{payment_method_type:null==state$2?void 0:state$2.method}:{},return_url:addQueryArgs(window.location.href,{...(null===(r=null==state$1?void 0:state$1.checkout)||void 0===r?void 0:r.id)?{checkout_id:null===(i=null==state$1?void 0:state$1.checkout)||void 0===i?void 0:i.id}:{},is_surecart_payment_redirect:!0})},data:d,processor:{id:state$2.id,manual:state$2.manual}}),["paid","processing"].includes(null===(s=state$1.checkout)||void 0===s?void 0:s.status)&&this.scPaid.emit(),(null===(c=null===(n=null===(a=null===(o=state$1.checkout)||void 0===o?void 0:o.payment_intent)||void 0===a?void 0:a.processor_data)||void 0===n?void 0:n.mollie)||void 0===c?void 0:c.checkout_url)?(updateFormState("PAYING"),setTimeout((()=>{var e,t,r,i;return window.location.assign(null===(i=null===(r=null===(t=null===(e=state$1.checkout)||void 0===e?void 0:e.payment_intent)||void 0===t?void 0:t.processor_data)||void 0===r?void 0:r.mollie)||void 0===i?void 0:i.checkout_url)}),50)):(setTimeout((()=>{updateFormState("PAYING")}),50),state$1.checkout)}catch(e){console.error(e),this.handleErrorResponse(e)}}async handlePaid(){updateFormState("PAID")}async handlePayError(){updateFormState("REJECT")}async handleAbandonedCartUpdate(e){const t=e.detail;this.loadUpdate({abandoned_checkout_enabled:t})}async handleCouponApply(e){const t=e.detail;this.scError.emit({}),this.loadUpdate({discount:{...t?{promotion_code:t}:{}}})}componentDidLoad(){this.findOrCreateOrder()}async findOrCreateOrder(){var e;const{redirect_status:t,checkout_id:r,line_items:i,coupon:s,is_surecart_payment_redirect:o}=getQueryArgs(window.location.href);if(window.history.replaceState({},document.title,removeQueryArgs(window.location.href,"redirect_status","coupon","line_items","confirm_checkout_id","checkout_id")),o&&r)return updateFormState("FINALIZE"),updateFormState("PAYING"),this.handleCheckoutIdFromUrl(r,s);if(t)return this.handleRedirectStatus(t,r);if(r)return this.handleCheckoutIdFromUrl(r,s);if(i)return this.handleInitialLineItems(i,s);const a=null===(e=null==state$1?void 0:state$1.checkout)||void 0===e?void 0:e.id;return a&&this.persist?this.handleExistingCheckout(a,s):this.handleNewCheckout(s)}async handleRedirectStatus(e,t){var r,i;if(console.info("Handling payment redirect."),"failed"===e)return this.scError.emit({message:wp.i18n.__("Payment unsuccessful. Please try again.","surecart")});if(!t)return this.scError.emit({message:wp.i18n.__("Could not find checkout. Please contact us before attempting to purchase again.","surecart")});try{updateFormState("FINALIZE"),updateFormState("PAID"),state$1.checkout=await fetchCheckout({id:t,query:{refresh_status:!0}}),(null===(r=state$1.checkout)||void 0===r?void 0:r.status)&&["paid","processing"].includes(null===(i=state$1.checkout)||void 0===i?void 0:i.status)&&setTimeout((()=>{this.scPaid.emit()}),100)}catch(e){this.handleErrorResponse(e)}}async handleCheckoutIdFromUrl(e,t=""){var r;if(console.info("Handling existing checkout from url.",t,e),t)return this.loadUpdate({id:e,discount:{promotion_code:t}});try{updateFormState("FETCH"),state$1.checkout=await fetchCheckout({id:e,query:{refresh_status:!0}}),updateFormState("RESOLVE")}catch(e){this.handleErrorResponse(e)}switch(null===(r=state$1.checkout)||void 0===r?void 0:r.status){case"paid":case"processing":return setTimeout((()=>{updateFormState("FINALIZE"),updateFormState("PAID"),this.scPaid.emit()}),100);case"payment_failed":return clearCheckout(),this.scError.emit({message:wp.i18n.__("Payment unsuccessful. Please try again.","surecart")});case"payment_intent_canceled":case"canceled":return clearCheckout(),this.scError.emit({message:wp.i18n.__("Payment canceled. Please try again.","surecart")});case"finalized":this.scError.emit({message:wp.i18n.__("Payment unsuccessful. Please try again.","surecart")}),updateFormState("REJECT")}}async handleInitialLineItems(e,t){console.info("Handling initial line items.");const r=this.el.querySelector("sc-order-shipping-address");return clearCheckout(),this.loadUpdate({line_items:e,...t?{discount:{promotion_code:t}}:{},...(null==r?void 0:r.defaultCountry)?{shipping_address:{country:null==r?void 0:r.defaultCountry}}:{}})}async handleNewCheckout(e){console.info("Handling new checkout.");const t=this.getFormData(),r=this.addPriceChoices(this.addInitialPrices()||[]),i=this.el.querySelector("sc-order-shipping-address");try{updateFormState("FETCH"),state$1.checkout=await createOrUpdateCheckout({data:{...t,...e?{discount:{promotion_code:e}}:{},...(null==i?void 0:i.defaultCountry)?{shipping_address:{country:null==i?void 0:i.defaultCountry}}:{},line_items:r}}),updateFormState("RESOLVE")}catch(e){console.error(e),this.handleErrorResponse(e)}}async handleExistingCheckout(e,t){if(!e)return this.handleNewCheckout(t);console.info("Handling existing checkout.");try{updateFormState("FETCH"),state$1.checkout=await createOrUpdateCheckout({id:e,data:{...t?{discount:{promotion_code:t}}:{}}}),updateFormState("RESOLVE")}catch(e){console.error(e),this.handleErrorResponse(e)}}async handleErrorResponse(e){var t,r,i,s;if(["checkout.not_found"].includes(null==e?void 0:e.code))return window.history.replaceState({},document.title,removeQueryArgs(window.location.href,"checkout_id")),clearCheckout(),this.handleNewCheckout(!1);if("order.line_items.old_price_versions"!==(null===(r=null===(t=null==e?void 0:e.additional_errors)||void 0===t?void 0:t[0])||void 0===r?void 0:r.code)){if(["order.invalid_status_transition"].includes(null==e?void 0:e.code))return await this.loadUpdate({id:null===(s=null==state$1?void 0:state$1.checkout)||void 0===s?void 0:s.id,data:{status:"draft"}}),void this.handleFormSubmit();if("rest_cookie_invalid_nonce"!==(null==e?void 0:e.code)){if("readonly"===(null==e?void 0:e.code))return clearCheckout(),void window.location.assign(removeQueryArgs(window.location.href,"order"));console.log("emit",e),this.scError.emit(e),updateFormState("REJECT")}else updateFormState("EXPIRE")}else await this.loadUpdate({id:null===(i=null==state$1?void 0:state$1.checkout)||void 0===i?void 0:i.id,data:{status:"draft",refresh_price_versions:!0}})}async initialize(e={}){let t=this.addInitialPrices()||[];return t=this.addPriceChoices(t),(null==t?void 0:t.length)?this.loadUpdate({line_items:t,...e}):this.loadUpdate({...e})}addInitialPrices(){var e;return(null===(e=null==this?void 0:this.prices)||void 0===e?void 0:e.length)?this.prices.some((e=>!(null==e?void 0:e.id)))?void 0:this.prices.map((e=>({price_id:e.id,quantity:e.quantity}))):[]}addPriceChoices(e=[]){return this.el.querySelectorAll("[price-id]").forEach((t=>{t.checked&&e.push({quantity:t.quantity||1,price_id:t.priceId,...t.defaultAmount?{ad_hoc_amount:t.defaultAmount}:{}}),t.defaultAmount&&e.push({quantity:t.quantity||1,price_id:t.priceId,ad_hoc_amount:t.defaultAmount})})),e}getSessionId(){var e,t;return getQueryArg(window.location.href,"checkout_id")||((null===(e=null==state$1?void 0:state$1.checkout)||void 0===e?void 0:e.id)?null===(t=null==state$1?void 0:state$1.checkout)||void 0===t?void 0:t.id:null)}async fetchCheckout(e,{query:t={},data:r={}}={}){try{updateFormState("FETCH");const i=await createOrUpdateCheckout({id:e,query:t,data:r});return updateFormState("RESOLVE"),i}catch(e){this.handleErrorResponse(e)}}async fetch(e={}){try{updateFormState("FETCH"),state$1.checkout=await fetchCheckout({id:this.getSessionId(),query:e}),updateFormState("RESOLVE")}catch(e){this.handleErrorResponse(e)}}async update(e={},t={}){try{state$1.checkout=await createOrUpdateCheckout({id:(null==e?void 0:e.id)?e.id:this.getSessionId(),data:e,query:t})}catch(e){if(["checkout.not_found"].includes(null==e?void 0:e.code))return clearCheckout(),this.initialize();throw console.error(e),e}}async loadUpdate(e={}){try{updateFormState("FETCH"),await this.update(e),updateFormState("RESOLVE")}catch(e){this.handleErrorResponse(e)}}render(){return h("sc-line-items-provider",{order:null==state$1?void 0:state$1.checkout,onScUpdateLineItems:e=>this.loadUpdate({line_items:e.detail})},h("slot",null))}get el(){return getElement(this)}static get watchers(){return{prices:["handlePricesChange"]}}};export{ScCheckoutUnsavedChangesWarning as sc_checkout_unsaved_changes_warning,ScFormComponentsValidator as sc_form_components_validator,ScFormErrorProvider as sc_form_error_provider,ScFormStateProvider as sc_form_state_provider,ScLoginProvider as sc_login_provider,ScOrderConfirmProvider as sc_order_confirm_provider,ScSessionProvider as sc_session_provider};