import{proxyCustomElement,HTMLElement,createEvent,h}from"@stencil/core/internal/client";import{p as pure}from"./pure.js";import{o as openWormhole}from"./consumer.js";import{s as state}from"./watchers3.js";import{d as defineCustomElement$3}from"./sc-skeleton2.js";import{d as defineCustomElement$2}from"./sc-text2.js";import{a as addQueryArgs}from"./add-query-args.js";const scStripePaymentElementCss="sc-stripe-payment-element{display:block}sc-stripe-payment-element [hidden]{display:none}.loader{display:grid;height:128px;gap:2em}.loader__row{display:flex;align-items:flex-start;justify-content:space-between;gap:1em}.loader__details{display:grid;gap:0.5em}",ScStripePaymentElement$1=proxyCustomElement(class extends HTMLElement{constructor(){super(),this.__registerHost(),this.scPaid=createEvent(this,"scPaid",7),this.scPayError=createEvent(this,"scPayError",7),this.scSetState=createEvent(this,"scSetState",7),this.loaded=!1,this.confirming=!1}async componentDidLoad(){this.initialize()}handleUpdatedChange(e,t){var i,s,r,o;if(this.error="",(null===(s=null===(i=null==e?void 0:e.processor_data)||void 0===i?void 0:i.stripe)||void 0===s?void 0:s.client_secret)!==(null===(o=null===(r=null==t?void 0:t.processor_data)||void 0===r?void 0:r.stripe)||void 0===o?void 0:o.client_secret))return this.initialize();this.elements.fetchUpdates()}async initialize(){var e,t,i,s,r,o,n,l,a,d,c,m;if((null===(i=null===(t=null===(e=this.stripePaymentIntent)||void 0===e?void 0:e.processor_data)||void 0===t?void 0:t.stripe)||void 0===i?void 0:i.publishable_key)&&(null===(o=null===(r=null===(s=this.stripePaymentIntent)||void 0===s?void 0:s.processor_data)||void 0===r?void 0:r.stripe)||void 0===o?void 0:o.account_id)){if(!this.stripe)try{this.stripe=await pure.loadStripe(null===(a=null===(l=null===(n=this.stripePaymentIntent)||void 0===n?void 0:n.processor_data)||void 0===l?void 0:l.stripe)||void 0===a?void 0:a.publishable_key,{stripeAccount:null===(m=null===(c=null===(d=this.stripePaymentIntent)||void 0===d?void 0:d.processor_data)||void 0===c?void 0:c.stripe)||void 0===m?void 0:m.account_id})}catch(e){return void(this.error=(null==e?void 0:e.message)||wp.i18n.__("Stripe could not be loaded","surecart"))}this.loadElement()}}handleUpdateElement(){var e,t;if(!this.element)return;if("draft"!==(null===(e=this.order)||void 0===e?void 0:e.status))return;const{name:i,email:s}=this.order,{line_1:r,line_2:o,city:n,state:l,country:a,postal_code:d}=(null===(t=this.order)||void 0===t?void 0:t.shipping_address)||{};this.element.update({defaultValues:{billingDetails:{name:i,email:s,address:{line1:r,line2:o,city:n,state:l,country:a,postal_code:d}}},fields:{billingDetails:{email:"never"}}}),this.elements.fetchUpdates()}async maybeConfirmOrder(e){var t,i,s,r,o,n,l,a,d,c;if("paying"===e&&"stripe"===(null==state?void 0:state.id)&&"stripe"===(null===(i=null===(t=this.order)||void 0===t?void 0:t.payment_intent)||void 0===i?void 0:i.processor_type)&&(null===(n=null===(o=null===(r=null===(s=this.order)||void 0===s?void 0:s.payment_intent)||void 0===r?void 0:r.processor_data)||void 0===o?void 0:o.stripe)||void 0===n?void 0:n.type))return await this.confirm(null===(c=null===(d=null===(a=null===(l=this.order)||void 0===l?void 0:l.payment_intent)||void 0===a?void 0:a.processor_data)||void 0===d?void 0:d.stripe)||void 0===c?void 0:c.type)}async confirm(e,t={}){const i={elements:this.elements,confirmParams:{return_url:addQueryArgs(window.location.href,{...this.order.id?{checkout_id:this.order.id}:{}}),payment_method_data:{billing_details:{email:this.order.email}}},redirect:"if_required",...t};if(!this.confirming&&this.stripe)try{this.scSetState.emit("PAYING");const t="setup"===e?await this.stripe.confirmSetup(i):await this.stripe.confirmPayment(i);if(null==t?void 0:t.error)throw this.error=t.error.message,t.error;this.scSetState.emit("PAID"),this.scPaid.emit()}catch(e){console.error(e),this.scPayError.emit(e),e.message&&(this.error=e.message)}finally{this.confirming=!1}}loadElement(){var e,t,i,s,r,o,n,l,a;if(!this.stripe||!(null===(i=null===(t=null===(e=this.stripePaymentIntent)||void 0===e?void 0:e.processor_data)||void 0===t?void 0:t.stripe)||void 0===i?void 0:i.client_secret)||!this.container)return void console.log("do not have stripe or");const d=getComputedStyle(this.el);this.elements=this.stripe.elements({clientSecret:null===(o=null===(r=null===(s=this.stripePaymentIntent)||void 0===s?void 0:s.processor_data)||void 0===r?void 0:r.stripe)||void 0===o?void 0:o.client_secret,appearance:{variables:{colorPrimary:d.getPropertyValue("--sc-color-primary-500"),colorText:d.getPropertyValue("--sc-input-label-color"),borderRadius:d.getPropertyValue("--sc-input-border-radius-medium"),colorBackground:d.getPropertyValue("--sc-input-background-color"),fontSizeBase:d.getPropertyValue("--sc-input-font-size-medium"),colorLogo:d.getPropertyValue("--sc-stripe-color-logo"),colorLogoTab:d.getPropertyValue("--sc-stripe-color-logo-tab"),colorLogoTabSelected:d.getPropertyValue("--sc-stripe-color-logo-tab-selected"),colorTextPlaceholder:d.getPropertyValue("--sc-input-placeholder-color")},rules:{".Input":{border:d.getPropertyValue("--sc-input-border")}}}});const{line_1:c,line_2:m,city:p,state:u,country:h,postal_code:v}=(null===(n=this.order)||void 0===n?void 0:n.shipping_address)||{};this.elements.create("payment",{defaultValues:{billingDetails:{name:null===(l=this.order)||void 0===l?void 0:l.name,email:null===(a=this.order)||void 0===a?void 0:a.email,address:{line1:c,line2:m,city:p,state:u,country:h,postal_code:v}}},fields:{billingDetails:{email:"never"}}}).mount(".sc-payment-element-container"),this.element=this.elements.getElement("payment"),this.element.on("ready",(()=>this.loaded=!0))}render(){return h("div",{class:"sc-stripe-payment-element","data-testid":"stripe-payment-element"},!!this.error&&h("sc-text",{style:{color:"var(--sc-color-danger-500)","--font-size":"var(--sc-font-size-small)",marginBottom:"0.5em"}},this.error),h("div",{class:"loader",hidden:this.loaded},h("div",{class:"loader__row"},h("div",{style:{width:"50%"}},h("sc-skeleton",{style:{width:"50%",marginBottom:"0.5em"}}),h("sc-skeleton",null)),h("div",{style:{flex:"1"}},h("sc-skeleton",{style:{width:"50%",marginBottom:"0.5em"}}),h("sc-skeleton",null)),h("div",{style:{flex:"1"}},h("sc-skeleton",{style:{width:"50%",marginBottom:"0.5em"}}),h("sc-skeleton",null))),h("div",{class:"loader__details"},h("sc-skeleton",{style:{height:"1rem"}}),h("sc-skeleton",{style:{height:"1rem",width:"30%"}}))),h("div",{hidden:!this.loaded,class:"sc-payment-element-container",ref:e=>this.container=e}))}get el(){return this}static get watchers(){return{stripePaymentIntent:["handleUpdatedChange"],order:["handleUpdateElement"],error:["handleUpdateElement"],formState:["maybeConfirmOrder"]}}static get style(){return scStripePaymentElementCss}},[0,"sc-stripe-payment-element",{stripePaymentIntent:[16],order:[16],address:[4],successUrl:[1,"success-url"],formState:[1,"form-state"],selectedProcessorId:[1,"selected-processor-id"],error:[32],loaded:[32],confirming:[32],confirm:[64]}]);function defineCustomElement$1(){"undefined"!=typeof customElements&&["sc-stripe-payment-element","sc-skeleton","sc-text"].forEach((e=>{switch(e){case"sc-stripe-payment-element":customElements.get(e)||customElements.define(e,ScStripePaymentElement$1);break;case"sc-skeleton":customElements.get(e)||defineCustomElement$3();break;case"sc-text":customElements.get(e)||defineCustomElement$2()}}))}openWormhole(ScStripePaymentElement$1,["order","selectedProcessorId","stripePaymentIntent","formState"],!0),defineCustomElement$1();const ScStripePaymentElement=ScStripePaymentElement$1,defineCustomElement=defineCustomElement$1;export{ScStripePaymentElement,defineCustomElement};