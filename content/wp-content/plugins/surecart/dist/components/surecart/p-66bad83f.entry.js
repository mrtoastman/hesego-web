import{r as i,c as t,h as l,g as o}from"./p-dfbe004d.js";import{p as s}from"./p-f0bb2283.js";import{o as n}from"./p-d63f2554.js";import{c as d,f as e}from"./p-ec9ca067.js";import"./p-112455b1.js";import"./p-10aa7556.js";import"./p-35c4916d.js";import"./p-1c2e2695.js";import"./p-47d251a3.js";import"./p-ea78c070.js";import"./p-0bb69f38.js";import"./p-9b6c2663.js";import"./p-d8453138.js";import"./p-4d73f82a.js";const a=class{constructor(e){i(this,e),this.scFormSubmit=t(this,"scFormSubmit",7),this.scPaid=t(this,"scPaid",7),this.scPayError=t(this,"scPayError",7),this.scSetState=t(this,"scSetState",7),this.scPaymentRequestLoaded=t(this,"scPaymentRequestLoaded",7),this.scUpdateOrderState=t(this,"scUpdateOrderState",7),this.country="US",this.currencyCode="usd",this.label="total",this.amount=0,this.theme="dark",this.debug=!1,this.loaded=!1}async componentWillLoad(){if(!(null==this?void 0:this.publishableKey)||!(null==this?void 0:this.stripeAccountId))return!0;try{this.stripe=await s.loadStripe(this.publishableKey,{stripeAccount:this.stripeAccountId}),this.elements=this.stripe.elements(),this.paymentRequest=this.stripe.paymentRequest({country:this.country,requestShipping:!0,requestPayerEmail:!0,shippingOptions:[{id:"free",label:"Free Shipping",detail:"No shipping required",amount:0}],...this.getRequestObject(this.order)})}catch(t){console.log((null==t?void 0:t.message)||wp.i18n.__("Stripe could not be loaded","surecart"))}}handleOrderChange(){this.paymentRequest&&(this.pendingEvent||this.paymentRequest.update(this.getRequestObject(this.order)))}handleLoaded(){this.scPaymentRequestLoaded.emit(!0)}handleErrorChange(){this.pendingEvent&&this.pendingEvent.complete("error")}async handleShippingChange(t){var e,i,n,o,s;const{shippingAddress:l,updateWith:r}=t;try{const t=await d({id:null===(e=this.order)||void 0===e?void 0:e.id,data:{shipping_address:{...(null==l?void 0:l.name)?{name:null==l?void 0:l.name}:{},...(null===(i=null==l?void 0:l.addressLine)||void 0===i?void 0:i[0])?{line_1:null===(n=null==l?void 0:l.addressLine)||void 0===n?void 0:n[0]}:{},...(null===(o=null==l?void 0:l.addressLine)||void 0===o?void 0:o[1])?{line_2:null===(s=null==l?void 0:l.addressLine)||void 0===s?void 0:s[1]}:{},...(null==l?void 0:l.city)?{city:null==l?void 0:l.city}:{},...(null==l?void 0:l.country)?{country:null==l?void 0:l.country}:{},...(null==l?void 0:l.postalCode)?{postal_code:null==l?void 0:l.postalCode}:{},...(null==l?void 0:l.region)?{state:null==l?void 0:l.region}:{}}}});r({status:"success",total:{amount:(null==t?void 0:t.amount_due)||0,label:wp.i18n.__("Total","surecart"),pending:!0}})}catch(t){t.updateWith({status:"invalid_shipping_address"})}}getName(t){var e,i,n,o,s;let d="";return d=Object.keys(this.prices||{}).filter((e=>this.prices[e].product===t.price.product.id)).length>1?`${null===(i=null===(e=null==t?void 0:t.price)||void 0===e?void 0:e.product)||void 0===i?void 0:i.name} â€“ ${null===(n=null==t?void 0:t.price)||void 0===n?void 0:n.name}`:null===(s=null===(o=null==t?void 0:t.price)||void 0===o?void 0:o.product)||void 0===s?void 0:s.name,d}getRequestObject(t){var e;const i=((null===(e=null==t?void 0:t.line_items)||void 0===e?void 0:e.data)||[]).map((t=>({label:this.getName(t),amount:null!==t.ad_hoc_amount?t.ad_hoc_amount:t.subtotal_amount})));return{currency:this.currencyCode,total:{amount:(null==t?void 0:t.amount_due)||0,label:wp.i18n.__("Total","surecart"),pending:!0},displayItems:i}}componentDidLoad(){if(!this.elements)return;const t=this.elements.create("paymentRequestButton",{paymentRequest:this.paymentRequest,style:{paymentRequestButton:{theme:this.theme}}});this.paymentRequest.on("paymentmethod",(t=>this.handlePaymentMethod(t))),this.paymentRequest.on("shippingaddresschange",(async t=>await this.handleShippingChange(t))),this.paymentRequest.canMakePayment().then((e=>{e?(t.mount(this.request),this.loaded=!0):"https:"!==location.protocol?(this.debug&&(this.debugError=wp.i18n.__("You must serve this page over HTTPS to display express payment buttons.","surecart")),console.log("SSL needed to display payment buttons.")):(this.debug&&(this.debugError=wp.i18n.__("You do not have any wallets set up in your browser.","surecart")),console.log("No wallets available."))})).catch((t=>{console.error(t)}))}async handlePaymentMethod(t){var i,n,o,s,l;const{billing_details:r}=null==t?void 0:t.paymentMethod,{shippingAddress:a}=t;try{this.scSetState.emit("FINALIZE"),await d({id:null===(i=this.order)||void 0===i?void 0:i.id,data:{email:null==r?void 0:r.email,name:null==r?void 0:r.name,shipping_address:{...(null==a?void 0:a.name)?{name:null==a?void 0:a.name}:{},...(null===(n=null==a?void 0:a.addressLine)||void 0===n?void 0:n[0])?{line_1:null===(o=null==a?void 0:a.addressLine)||void 0===o?void 0:o[0]}:{},...(null===(s=null==a?void 0:a.addressLine)||void 0===s?void 0:s[1])?{line_2:null===(l=null==a?void 0:a.addressLine)||void 0===l?void 0:l[1]}:{},...(null==a?void 0:a.city)?{city:null==a?void 0:a.city}:{},...(null==a?void 0:a.country)?{country:null==a?void 0:a.country}:{},...(null==a?void 0:a.postalCode)?{postal_code:null==a?void 0:a.postalCode}:{},...(null==a?void 0:a.region)?{state:null==a?void 0:a.region}:{}}}});const u=await e({id:this.order.id,query:{form_id:this.formId},processor:{id:"stripe",manual:!1}});this.scSetState.emit("PAYING"),await this.confirmPayment(u,t),this.scSetState.emit("PAID"),this.scPaid.emit(),t.complete("success")}catch(i){console.error(i),this.scPayError.emit(i),t.complete("fail")}finally{this.confirming=!1}}async confirmPayment(t,e){var i,n,o,s,d,l,r,a,u,p,c,h,m,v,y,_,g,b;if("finalized"!==(null==t?void 0:t.status))return;if(!(null===(o=null===(n=null===(i=null==t?void 0:t.payment_intent)||void 0===i?void 0:i.processor_data)||void 0===n?void 0:n.stripe)||void 0===o?void 0:o.client_secret))return;if(!(null===(l=null===(d=null===(s=null==t?void 0:t.payment_intent)||void 0===s?void 0:s.processor_data)||void 0===d?void 0:d.stripe)||void 0===l?void 0:l.type))return;if(!(null===(r=null==t?void 0:t.payment_intent)||void 0===r?void 0:r.external_intent_id))return;if(this.confirming)return;let f;if(this.confirming=!0,f="setup"==(null===(p=null===(u=null===(a=null==t?void 0:t.payment_intent)||void 0===a?void 0:a.processor_data)||void 0===u?void 0:u.stripe)||void 0===p?void 0:p.type)?await this.confirmCardSetup(null===(h=null===(c=null==t?void 0:t.payment_intent)||void 0===c?void 0:c.processor_data)||void 0===h?void 0:h.stripe.client_secret,e):await this.confirmCardPayment(null===(v=null===(m=null==t?void 0:t.payment_intent)||void 0===m?void 0:m.processor_data)||void 0===v?void 0:v.stripe.client_secret,e),null==f?void 0:f.error)throw f.error;if("requires_action"===(null===(y=null==f?void 0:f.paymentIntent)||void 0===y?void 0:y.status)||"requires_source_action"===(null===(_=null==f?void 0:f.paymentIntent)||void 0===_?void 0:_.status)){const e=await this.stripe.confirmCardPayment(null===(b=null===(g=null==t?void 0:t.payment_intent)||void 0===g?void 0:g.processor_data)||void 0===b?void 0:b.stripe.client_secret);if(e.error)throw e.error;return e}return f}confirmCardPayment(t,e){return this.stripe.confirmCardPayment(t,{payment_method:e.paymentMethod.id},{handleActions:!1})}confirmCardSetup(t,e){return this.stripe.confirmCardSetup(t,{payment_method:e.paymentMethod.id},{handleActions:!1})}render(){return l("div",{class:{request:!0,"request--loaded":this.loaded}},this.debug&&this.debugError&&l("div",null,l("slot",{name:"debug-fallback"}),l("sc-alert",{type:"info",open:!0},l("span",{slot:"title"},wp.i18n.__("Express Payment","surecart")),this.debugError)),l("div",{class:"sc-payment-request-button",part:"button",ref:t=>this.request=t}))}get el(){return o(this)}static get watchers(){return{order:["handleOrderChange"],loaded:["handleLoaded"],error:["handleErrorChange"]}}};n(a,["currencyCode","country","prices","paymentMethod"],!1),a.style=":host{display:block}.or{display:none;margin:var(--sc-form-section-spacing) 0}.request--loaded .or{display:block}";export{a as sc_stripe_payment_request};